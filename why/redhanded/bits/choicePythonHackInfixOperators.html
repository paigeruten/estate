<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "DTD/xhtml1-transitional.dtd">
<!-- saved from url=(0102)redhanded.hobix.com/bits/choicePythonHackInfixOperators.html -->
<HTML xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><HEAD><META http-equiv="Content-Type" content="text/html; charset=UTF-8">
<!--<BASE href="http://redhanded.hobix.com.wstub.archive.org/bits/choicePythonHackInfixOperators.html">--><BASE href=".">


<TITLE>RedHanded » Choice Python Hack: Infix Operators</TITLE>
<LINK rel="shortcut icon" href="../favicon.ico" type="image/vnd.microsoft.icon" />
<LINK rel="icon" href="../favicon.ico" type="image/vnd.microsoft.icon" />
<META http-equiv="Pragma" content="no-cache">
<META http-equiv="Expires" content="-1">




<STYLE type="text/css">
 @import "../site.css"; 
</STYLE>
</HEAD><BODY>

<DIV id="page">

<DIV id="hoodwinkd">
  <A href="http://hoodwinkd.hobix.com/"><SPAN>hoodwink.d enhanced</SPAN></A>

</DIV>
<DIV id="buttons">
<DL class="tab">
  <DT><A title="Syndicate this Site" href="index.xml">RSS</A></DT>
  <DD><A title="Syndicate this Site" href="index.xml">2.0</A></DD>
</DL>
<DL class="tab xhtml">
  <DT><A title="Validate this Site" href="http://validator.w3.org/check?uri=http://redhanded.hobix.com/">XHTML</A></DT>
  <DD><A title="Validate this Site" href="http://validator.w3.org/check?uri=http://redhanded.hobix.com/">1.0</A></DD>
</DL>
</DIV>
<H1 class="title"><A href="../"><IMG src="../images/redhanded.gif" alt="RedHanded"></A></H1>
<DIV id="banner">
  <DIV class="tagline">sneaking Ruby through the system</DIV>
  <DIV class="nav"><A href="../5.gets/">5.gets</A> | <A href="../bits/">bits</A> | 
    <A href="../inspect/">inspect</A> | <A href="../cult/">the cult</A> | <A href="../-h/">-h</A></DIV>
</DIV>


<DIV id="content">
<DIV id="sidebar">
<P>New to RedHanded? <A href="../-h/pardonAndWelcome.html">About our sections.</A></P>

<DIV class="sidebarBox">
<H2 class="sidebarTitle">Archive</H2>
<UL>

    <LI><A href="../2004/12/">December 2004</A></LI>

    <LI><A href="../2005/01/">January 2005</A></LI>

    <LI><A href="../2005/02/">February 2005</A></LI>

    <LI><A href="../2005/03/">March 2005</A></LI>

    <LI><A href="../2005/04/">April 2005</A></LI>

    <LI><A href="../2005/05/">May 2005</A></LI>

    <LI><A href="../2005/06/">June 2005</A></LI>

    <LI><A href="../2005/07/">July 2005</A></LI>

    <LI><A href="../2005/08/">August 2005</A></LI>

    <LI><A href="../2005/09/">September 2005</A></LI>

    <LI><A href="../2005/10/">October 2005</A></LI>

    <LI><A href="../2005/11/">November 2005</A></LI>

    <LI><A href="../2005/12/">December 2005</A></LI>

    <LI><A href="../2006/01/">January 2006</A></LI>

    <LI><A href="../2006/02/">February 2006</A></LI>

    <LI><A href="../2006/03/">March 2006</A></LI>

    <LI><A href="../2006/04/">April 2006</A></LI>

    <LI><A href="../2006/05/">May 2006</A></LI>

    <LI><A href="../2006/06/">June 2006</A></LI>

    <LI><A href="../2006/07/">July 2006</A></LI>

    <LI><A href="../2006/08/">August 2006</A></LI>

    <LI><A href="../2006/09/">September 2006</A></LI>

    <LI><A href="../2006/10/">October 2006</A></LI>

    <LI><A href="../2006/11/">November 2006</A></LI>

    <LI><A href="../2006/12/">December 2006</A></LI>

    <LI><A href="../2007/01/">January 2007</A></LI>

    <LI><A href="../2007/02/">February 2007</A></LI>

    <LI><A href="../2007/03/">March 2007</A></LI>

    <LI><A href="../2007/04/">April 2007</A></LI>

    <LI><A href="../2007/05/">May 2007</A></LI>

</UL>
</DIV>

<P><A href="http://www.pragmaticprogrammer.com/titles/ruby/index.html"><IMG src="../images/prag-ruby-book.jpg" alt="PickAxe II"></A><BR>
<A href="http://www.pragmaticprogrammer.com/titles/ruby/index.html">Get your copy of <I>Programming Ruby</I>!</A></P>

 <DIV class="sidebarBox">
        <H2 class="sidebarTitle">Links</H2>
        <A href="http://technorati.com/tags/ruby">@technorati</A><BR>
<A href="http://del.icio.us/tag/ruby">@del.icio.us</A><BR>
<A href="http://www.flickr.com/photos/tags/ruby">@flickr</A><BR>
<A href="http://www.artima.com/articles/index.jsp?topic=ruby">@artima</A><BR>
<A href="http://blog.caboo.se/">@caboo</A><BR>
<A href="http://www.oreillynet.com/ruby">@oreilly</A><BR>
<A href="http://ruby-lang.org/">ruby</A><BR>
<A href="http://ruby-doc.org/">-&gt; docs</A><BR>
<A href="http://rubyforge.org/">-&gt; wares</A><BR>
<A href="http://rubygarden.org/ruby/">-&gt; wiki</A><BR>
<A href="http://www.sitepoint.com/forums/forumdisplay.php?f=227">-&gt; forum</A><BR>
<A href="http://www.rubyquiz.com/">-&gt; quizzes</A><BR>
<A href="http://planetruby.0x42.net/">-&gt; planet</A><BR>
<A href="http://meme.b9.com/cdates.html?channel=ruby-lang">-&gt; irc</A><BR>
<A href="http://www.rubyweeklynews.org/">rubyweeklynews</A><BR>
<A href="http://weblog.rubyonrails.com/">rails</A><BR>
<A href="http://wiki.rubyonrails.org/">-&gt; wiki</A><BR>
<A href="http://www.planetrubyonrails.org/">-&gt; planet</A><BR>
<A href="http://thesaq.com/rubyonrails/">-&gt; irc</A><BR>
<A href="http://anarchaia.org/">%anarchaia</A><BR>
<A href="http://project.ioni.st/">%projectionist</A><BR>
<A href="http://pugs.blogs.com/">~audreyt</A><BR>
<A href="http://dablog.rubypal.com/">~black</A><BR>
<A href="http://www.jamesbritt.com/">~britt</A><BR>
<A href="http://www.jamisbuck.org/jamis/">~buck</A><BR>
<A href="http://tomcopeland.blogs.com/juniordeveloper/">~copeland</A><BR>
<A href="http://eigenclass.org/">~fernandez</A><BR>
<A href="http://www.chadfowler.com/">~fowler</A><BR>
<A href="http://www.loudthinking.com/">~hansson</A><BR>
<A href="http://blog.segment7.net/">~hodel</A><BR>
<A href="http://slash7.com/">~hoy/7</A><BR>
<A href="http://fhwang.net/">~hwang</A><BR>
<A href="http://blog.leetsoft.com/">~luetke</A><BR>
<A href="http://www.worldlingo.com/wl/translate?wl_lp=JA-en&wl_glossary=gl1&wl_fl=3&wl_rurl=http%3A%2F%2Fwww.rubyist.net%2F%7Ematz%2F&wl_url=http%3A%2F%2Fwww.rubyist.net%2F%7Ematz%2F&wl_g_table=-3">~matz</A><BR>
<A href="http://moonbase.rydia.net/">~mental</A><BR>
<A href="http://techno-weenie.net/">~olson</A><BR>
<A href="http://pragprog.com/pragdave">~pragdave</A><BR>
<A href="http://www.livejournal.com/users/premshree/">~premshree</A><BR>
<A href="http://kronavita.de/chris/blog/">~neukirchen</A><BR>
<A href="http://www.robbyonrails.com/">~robby</A><BR>
<A href="http://www.rousette.org.uk/">~rousette</A><BR>
<A href="http://nubyonrails.com/">~topfunky</A><BR>
<A href="http://www.jvoorhis.com/">~voorhis</A><BR>
<A href="http://onestepback.org/">~weirich</A><BR>
<A href="http://blog.zenspider.com/">~zenspider</A><BR>
        </DIV> 
 <DIV class="sidebarBox">
        <H2 class="sidebarTitle">Syndicate</H2>
        <UL>
            <LI><A href="../index.xml">RSS 2.0</A></LI>
        </UL>
        </DIV> 
 <DIV class="sidebarBox">
        <P>Built upon <A href="http://hobix.com/">Hobix</A></P>
        </DIV> 
<IMG src="../images/redhanded-duck.gif" alt="Type the Duck">
<DIV class="email">Got a story for us? <A href="../mailto:redhanded@hobix.com">E-mail it!</A></DIV>
<DIV class="technorati"><P><A href="http://www.technorati.com/profile/whytheluckystiff">Technorati Profile</A>
<A href="http://www.technorati.com/cosmos/search.html?url=http%3A%2F%2Fredhanded.hobix.com"><BR>
<IMG src="../images/bubble_icon.gif" height="20" width="24" alt="Get Conversations about RedHanded &raquo; sneaking Ruby through the system"></A>
</P>
</DIV>

</DIV>


 <DIV id="blog">
        
<DIV class="entry">
    <H2 class="entryTitle">Choice Python Hack: Infix Operators
  <SPAN class="entryPermalink"><A href="../bits/choicePythonHackInfixOperators.html" title="Permanent link to &ldquo;Choice Python Hack: Infix Operators&rdquo;">#</A></SPAN>
</H2>

<DIV class="entrySection">by <A href="http://whytheluckystiff.net/" title="Visit why&#39;s homepage">why</A> 
  in <A href="../bits" title="List of entries in the &ldquo;bits&rdquo; category">bits</A>
</DIV>

     <DIV class="entryContent"><P>Pencils down.  Cool hack for Python <A href="http://aspn.activestate.com/ASPN/Cookbook/Python/Recipe/384122">right here</A>.  I guess this was up on LtU a few days ago.  I saw it on <A href="http://farm.tucows.com/">The Farm</A>, so.</P>


	<P>Works like:</P>


<PRE> # simple multiplication
 x=Infix(lambda x,y: x*y)
 print 2 |x| 4
 # =&gt; 8

 # class checking
 isa=Infix(lambda x,y: x.__class__==y.__class__)
 print [1,2,3] |isa| []
 print [1,2,3] &lt;&lt;isa&gt;&gt; []
 # =&gt; True

 # inclusion checking
 is_in=Infix(lambda x,y: y.has_key(x))
 print 1 |is_in| {1:'one'}
 print 1 &lt;&lt;is_in&gt;&gt; {1:'one'}
 # =&gt; True
</PRE>

	<P>Anyway, this hacker—Ferdinand Jamitzky—sure would fit in well over here.  He’s tread so close to our territory.  What with the <A href="http://aspn.activestate.com/ASPN/Cookbook/Python/Recipe/271669">Ruby-like syntatic sugar</A> he supplied for Python last year.</P>


<PRE> 5 *times(lambda: printf("Hello"))
 [1,2,3,4] *each(lambda x: printf("Count:"+str(x)))
 print [1,2,3,4,5] *length
 ['a','b','c','d','e'] *each(lambda char: char+'!')
</PRE>

	<P>I mean if he can make Python look like Ruby, maybe he can make Ruby look like dolphin sonar.  Can you best these??</P></DIV> 
</DIV>
<DIV class="entryFooter"> 
    <NOBR>22 Feb 2005</NOBR> at <NOBR>16:43</NOBR>
    <NOSCRIPT></NOSCRIPT>
   | 
    9 comments
</DIV>
</DIV>
<DIV id="comments">


<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>flgr</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>22 Feb 2005</NOBR> at <NOBR>17:08</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P>Here’s my Ruby implementation. We seem to be reading the same stuff lately.</P>


	<P>Note that Ruby even lets you define Unicode operators like 5 |∈| [1, 2, 3].</P>


<PRE>require 'thread'

def infix(name, code = nil, &amp;block)
  if code and block or
     code.nil? and block.nil?
  then
    raise(ArgumentError, "Have to specify code or block")
  end

  block ||= code

  Kernel.send(:define_method, name) do
    Infix.new(name, block)
  end
end

class Infix
  class LCall
    def initialize(name, op, type, left)
      @name, @op, @type, @left = name, op, type, left

      case @type
        when "|" then
          def self.|(right)
            @op.call(@left, right)
          end

        when "&lt;&lt;" then
        def self.&gt;&gt;(right)
            @op.call(@left, right)
          end 
   end
    end
  end

  def initialize(name, op)
    @name, @op = name, op
  end

  def lcall(type, left)
    LCall.new(@name, @op, type, left)
  end
end

ops = {
  '|' =&gt; 'old_or_op',
  '&lt;&lt;' =&gt; 'old_lsh_op'
}

overload_op = lambda do |op, mod|
  mod.module_eval do
    if instance_methods(false).include?(op) then
      old_op = instance_method(op)
      undef_method(op)
    end

    define_method(op) do |other|
      if other.class == Infix then
        other.lcall(op, self)
     elsif old_op then
        old_op.bind(self).call(other)
      else
        msg = "undefined method `#{op}' for #{self.inspect}:#{self.class}" 
        raise(NoMethodError, msg)
      end
    end
  end
end

init = true

overload_ops = lambda do |mod, singleton|
  ops.each do |op, old_name|
    overload_op.call(op, mod)
  end

  unless singleton
    mod.module_eval do
      define_method(:singleton_method_added) do |name|
     return if @overload_op

        Thread.exclusive do
          if not init and ops.include?(name.to_s) and
             self.class != Infix::LCall
          then
            @overload_op = true
            overload_op.call(name.to_s, class &lt;&lt; self; self; end)
            @overload_op = false
          end
        end 
      end         
    end

    class &lt;&lt; mod; self; end.module_eval do
      define_method(:method_added) do |name|
        return if @overload_op

        Thread.exclusive do
          if not init and ops.include?(name.to_s) and
            self != Infix::LCall
          then
  @overload_op = true
            overload_op.call(name.to_s, self)
            @overload_op = false
          end
        end
      end
    end
  end
end

overload_obj_ops = lambda do |obj|
  if not obj.methods(false).empty? then
    singleton = class &lt;&lt; obj; self; end
  overload_ops.call(singleton, true)
  end 
end

ObjectSpace.each_object(Module) do |mod|
  overload_ops.call(mod, false) if mod != Infix::LCall
end

ObjectSpace.each_object(Object) do |obj|
 overload_obj_ops.call(obj) if obj.class != Infix::LCall
end

init = false

infix :in? do |left, right|
  right.include? left
end
</PRE></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>Jamis</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>22 Feb 2005</NOBR> at <NOBR>17:33</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P>Well, my solution isn’t nearly as robust as flgr, but it seems to do the job:</P>


<PRE>class Infix
  def initialize( &amp;block )
    @op = block
  end
end

def +(a)
  if @op.arity == 1
    @op[a]
  else
    Infix.new { |b| @op.call(a,b) }
  end
end

def &lt;(a)
  Infix.new { |b| @op.call(a,b) }
end

def &gt;(a)
  @op.call(a)
end

def coerce(other)
  [self,other]
end

In = Infix.new { |left,right| right.include? left }

puts( 5 &lt;In&gt; [ 1, 2, 3, 4, 5 ] )
puts( 5 +In+ [ 6, 7, 8, 9, 0 ] )</PRE></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>slumos</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>23 Feb 2005</NOBR> at <NOBR>01:25</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P>why: code in comments is all icky.  Jamis’s code is partly behind this comment box and continues well below.  And flgr’s code seems to be hiding behind Jamis’s code.  This is Firefox 1.0 on  OSX , which ought to be the same as Firefox 1.0 on anything.</P></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>kHebSkik</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>23 Feb 2005</NOBR> at <NOBR>02:43</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P>Ok. Does anyone care to explain flgr’s solution
to people with less developed cortices?</P></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>kHebSkik</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>23 Feb 2005</NOBR> at <NOBR>03:14</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P>Right. In the old tradition of answering ones own question, here I go.</P>


	<P>Basiccally, flrg’s solution overrides ’|’ and
‘&lt;&lt;’ to call an instance of ‘Infix::LCall’. This
instance has overridden either ’|’ or ‘&gt;&gt;’.</P>


	<P>This allows you to write, for example</P>


<PRE><CODE>5 |in| [1,3,5]</CODE></PRE>

	<P>The interpreter sees this (more or less as)</P>


<PRE><CODE>(Kernel.|(5)).|([1,3,5])</CODE></PRE>

	<P>where the last ’|’ is the one overridden by Infix::LCall, as you can see from:</P>


<PRE><CODE>
puts(5 | in?)
#=&gt; #Infix::LCall:0x40139fa0
</CODE></PRE>

	<P>Beautiful. Yet at the same time I smell just a
little hint of utter <EM>perversion</EM>.</P>


	<P>My compliments!</P></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>flgr</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>23 Feb 2005</NOBR> at <NOBR>08:03</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P>Note that most of the work my solution does is overriding the x.| in x |infix| y by usings ObjectSpace, method_added and lots of other magic. The python guys don’t need to do that as they already seem to have right-side operators for exactly that. But then again they can not define Unicode operators in this way.</P></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>norseman</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>23 Feb 2005</NOBR> at <NOBR>15:54</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P>So other than sugar, when would someone use this?</P>


	<P>And yea, _why contributed scrollbars unto the code tag, and there was much rejoicing as the resize keys in firefox where tired from their repeated striking.
Ok, is it _why or why ?</P></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>muir</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>24 Feb 2005</NOBR> at <NOBR>10:48</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P>_why do you ask?</P></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>why</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>24 Feb 2005</NOBR> at <NOBR>11:08</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P>the underscore clears up ambiguity.  gheesh, tell me about it.</P></DIV></DIV>
</DIV>


  <DIV class="entry">
    <P><SMALL>Comments are closed for this entry.</SMALL></P>
  



        </DIV> 

</DIV>



</DIV>





</DIV></BODY></HTML>