<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "DTD/xhtml1-transitional.dtd">
<!-- saved from url=(0100)redhanded.hobix.com/inspect/nikolaiSUtf8LibIsAllReady.html -->
<HTML xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><HEAD><META http-equiv="Content-Type" content="text/html; charset=UTF-8">
<!--<BASE href="http://redhanded.hobix.com.wstub.archive.org/inspect/nikolaiSUtf8LibIsAllReady.html">--><BASE href=".">


<TITLE>RedHanded » Nikolai's UTF-8 Lib is All Ready</TITLE>
<LINK rel="shortcut icon" href="../favicon.ico" type="image/vnd.microsoft.icon" />
<LINK rel="icon" href="../favicon.ico" type="image/vnd.microsoft.icon" />
<META http-equiv="Pragma" content="no-cache">
<META http-equiv="Expires" content="-1">




<STYLE type="text/css">
 @import "../site.css"; 
</STYLE>
</HEAD><BODY>

<DIV id="page">

<DIV id="hoodwinkd">
  <A href="http://hoodwinkd.hobix.com/"><SPAN>hoodwink.d enhanced</SPAN></A>

</DIV>
<DIV id="buttons">
<DL class="tab">
  <DT><A title="Syndicate this Site" href="index.xml">RSS</A></DT>
  <DD><A title="Syndicate this Site" href="index.xml">2.0</A></DD>
</DL>
<DL class="tab xhtml">
  <DT><A title="Validate this Site" href="http://validator.w3.org/check?uri=http://redhanded.hobix.com/">XHTML</A></DT>
  <DD><A title="Validate this Site" href="http://validator.w3.org/check?uri=http://redhanded.hobix.com/">1.0</A></DD>
</DL>
</DIV>
<H1 class="title"><A href="../"><IMG src="../images/redhanded.gif" alt="RedHanded"></A></H1>
<DIV id="banner">
  <DIV class="tagline">sneaking Ruby through the system</DIV>
  <DIV class="nav"><A href="../5.gets/">5.gets</A> | <A href="../bits/">bits</A> | 
    <A href="../inspect/">inspect</A> | <A href="../cult/">the cult</A> | <A href="../-h/">-h</A></DIV>
</DIV>


<DIV id="content">
<DIV id="sidebar">
<P>New to RedHanded? <A href="../-h/pardonAndWelcome.html">About our sections.</A></P>

<DIV class="sidebarBox">
<H2 class="sidebarTitle">Archive</H2>
<UL>

    <LI><A href="../2004/12/">December 2004</A></LI>

    <LI><A href="../2005/01/">January 2005</A></LI>

    <LI><A href="../2005/02/">February 2005</A></LI>

    <LI><A href="../2005/03/">March 2005</A></LI>

    <LI><A href="../2005/04/">April 2005</A></LI>

    <LI><A href="../2005/05/">May 2005</A></LI>

    <LI><A href="../2005/06/">June 2005</A></LI>

    <LI><A href="../2005/07/">July 2005</A></LI>

    <LI><A href="../2005/08/">August 2005</A></LI>

    <LI><A href="../2005/09/">September 2005</A></LI>

    <LI><A href="../2005/10/">October 2005</A></LI>

    <LI><A href="../2005/11/">November 2005</A></LI>

    <LI><A href="../2005/12/">December 2005</A></LI>

    <LI><A href="../2006/01/">January 2006</A></LI>

    <LI><A href="../2006/02/">February 2006</A></LI>

    <LI><A href="../2006/03/">March 2006</A></LI>

    <LI><A href="../2006/04/">April 2006</A></LI>

    <LI><A href="../2006/05/">May 2006</A></LI>

    <LI><A href="../2006/06/">June 2006</A></LI>

    <LI><A href="../2006/07/">July 2006</A></LI>

    <LI><A href="../2006/08/">August 2006</A></LI>

    <LI><A href="../2006/09/">September 2006</A></LI>

    <LI><A href="../2006/10/">October 2006</A></LI>

    <LI><A href="../2006/11/">November 2006</A></LI>

    <LI><A href="../2006/12/">December 2006</A></LI>

    <LI><A href="../2007/01/">January 2007</A></LI>

    <LI><A href="../2007/02/">February 2007</A></LI>

    <LI><A href="../2007/03/">March 2007</A></LI>

    <LI><A href="../2007/04/">April 2007</A></LI>

    <LI><A href="../2007/05/">May 2007</A></LI>

</UL>
</DIV>

<P><A href="http://www.pragmaticprogrammer.com/titles/ruby/index.html"><IMG src="../images/prag-ruby-book.jpg" alt="PickAxe II"></A><BR>
<A href="http://www.pragmaticprogrammer.com/titles/ruby/index.html">Get your copy of <I>Programming Ruby</I>!</A></P>

 <DIV class="sidebarBox">
        <H2 class="sidebarTitle">Links</H2>
        <A href="http://technorati.com/tags/ruby">@technorati</A><BR>
<A href="http://del.icio.us/tag/ruby">@del.icio.us</A><BR>
<A href="http://www.flickr.com/photos/tags/ruby">@flickr</A><BR>
<A href="http://www.artima.com/articles/index.jsp?topic=ruby">@artima</A><BR>
<A href="http://blog.caboo.se/">@caboo</A><BR>
<A href="http://www.oreillynet.com/ruby">@oreilly</A><BR>
<A href="http://ruby-lang.org/">ruby</A><BR>
<A href="http://ruby-doc.org/">-&gt; docs</A><BR>
<A href="http://rubyforge.org/">-&gt; wares</A><BR>
<A href="http://rubygarden.org/ruby/">-&gt; wiki</A><BR>
<A href="http://www.sitepoint.com/forums/forumdisplay.php?f=227">-&gt; forum</A><BR>
<A href="http://www.rubyquiz.com/">-&gt; quizzes</A><BR>
<A href="http://planetruby.0x42.net/">-&gt; planet</A><BR>
<A href="http://meme.b9.com/cdates.html?channel=ruby-lang">-&gt; irc</A><BR>
<A href="http://www.rubyweeklynews.org/">rubyweeklynews</A><BR>
<A href="http://weblog.rubyonrails.com/">rails</A><BR>
<A href="http://wiki.rubyonrails.org/">-&gt; wiki</A><BR>
<A href="http://www.planetrubyonrails.org/">-&gt; planet</A><BR>
<A href="http://thesaq.com/rubyonrails/">-&gt; irc</A><BR>
<A href="http://anarchaia.org/">%anarchaia</A><BR>
<A href="http://project.ioni.st/">%projectionist</A><BR>
<A href="http://pugs.blogs.com/">~audreyt</A><BR>
<A href="http://dablog.rubypal.com/">~black</A><BR>
<A href="http://www.jamesbritt.com/">~britt</A><BR>
<A href="http://www.jamisbuck.org/jamis/">~buck</A><BR>
<A href="http://tomcopeland.blogs.com/juniordeveloper/">~copeland</A><BR>
<A href="http://eigenclass.org/">~fernandez</A><BR>
<A href="http://www.chadfowler.com/">~fowler</A><BR>
<A href="http://www.loudthinking.com/">~hansson</A><BR>
<A href="http://blog.segment7.net/">~hodel</A><BR>
<A href="http://slash7.com/">~hoy/7</A><BR>
<A href="http://fhwang.net/">~hwang</A><BR>
<A href="http://blog.leetsoft.com/">~luetke</A><BR>
<A href="http://www.worldlingo.com/wl/translate?wl_lp=JA-en&wl_glossary=gl1&wl_fl=3&wl_rurl=http%3A%2F%2Fwww.rubyist.net%2F%7Ematz%2F&wl_url=http%3A%2F%2Fwww.rubyist.net%2F%7Ematz%2F&wl_g_table=-3">~matz</A><BR>
<A href="http://moonbase.rydia.net/">~mental</A><BR>
<A href="http://techno-weenie.net/">~olson</A><BR>
<A href="http://pragprog.com/pragdave">~pragdave</A><BR>
<A href="http://www.livejournal.com/users/premshree/">~premshree</A><BR>
<A href="http://kronavita.de/chris/blog/">~neukirchen</A><BR>
<A href="http://www.robbyonrails.com/">~robby</A><BR>
<A href="http://www.rousette.org.uk/">~rousette</A><BR>
<A href="http://nubyonrails.com/">~topfunky</A><BR>
<A href="http://www.jvoorhis.com/">~voorhis</A><BR>
<A href="http://onestepback.org/">~weirich</A><BR>
<A href="http://blog.zenspider.com/">~zenspider</A><BR>
        </DIV> 
 <DIV class="sidebarBox">
        <H2 class="sidebarTitle">Syndicate</H2>
        <UL>
            <LI><A href="../index.xml">RSS 2.0</A></LI>
        </UL>
        </DIV> 
 <DIV class="sidebarBox">
        <P>Built upon <A href="http://hobix.com/">Hobix</A></P>
        </DIV> 
<IMG src="../images/redhanded-duck.gif" alt="Type the Duck">
<DIV class="email">Got a story for us? <A href="../mailto:redhanded@hobix.com">E-mail it!</A></DIV>
<DIV class="technorati"><P><A href="http://www.technorati.com/profile/whytheluckystiff">Technorati Profile</A>
<A href="http://www.technorati.com/cosmos/search.html?url=http%3A%2F%2Fredhanded.hobix.com"><BR>
<IMG src="../images/bubble_icon.gif" height="20" width="24" alt="Get Conversations about RedHanded &raquo; sneaking Ruby through the system"></A>
</P>
</DIV>

</DIV>


 <DIV id="blog">
        
<DIV class="entry">
    <H2 class="entryTitle">Nikolai's UTF-8 Lib is All Ready
  <SPAN class="entryPermalink"><A href="../inspect/nikolaiSUtf8LibIsAllReady.html" title="Permanent link to &ldquo;Nikolai&#39;s UTF-8 Lib is All Ready&rdquo;">#</A></SPAN>
</H2>

<DIV class="entrySection">by <A href="http://whytheluckystiff.net/" title="Visit why&#39;s homepage">why</A> 
  in <A href="../inspect" title="List of entries in the &ldquo;inspect&rdquo; category">inspect</A>
</DIV>

     <DIV class="entryContent"><P>Last week, in <A href="../inspect/muckingWithUnicodeFor18.html#comments">the comments</A>, Nikolai Weibull brought up his <SPAN class="caps">UTF</SPAN>-8 lib, a lovely creature which meets my own needs much better than what’s already out there.  I like it much better than my own efforts.  Especially now that he’s had some time to flesh it out.</P>


	<P>Namely: It’s small.  It’s coded in C.  It locks into Ruby’s existing string class.  Therefore, it can be efficient with memory and use Ruby’s own regexps.</P>


<PRE> require 'encoding/character/utf-8'
 str = u"hëllö" 
 str.length
   #=&gt; 5
 str.reverse.length
   #=&gt; 5
 str[/ël/]
   #=&gt; "ël" 
</PRE>

	<P>If you’d like to follow development, clone <A href="http://git.bitwi.se/ruby-character-encodings.git">this</A> (<A href="http://git.bitwi.se/?p=ruby-character-encodings.git;a=summary">git-web</A>.)  I’ve also put up a gem: <CODE>gem install character-encodings --source code.whytheluckystiff.net</CODE>, but obviously it’s not an official release or anything.</P></DIV> 
</DIV>
<DIV class="entryFooter"> 
    <NOBR>24 Jul 2006</NOBR> at <NOBR>10:22</NOBR>
    <NOSCRIPT></NOSCRIPT>
   | 
    32 comments
</DIV>
</DIV>
<DIV id="comments">


<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>FlashHater</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>24 Jul 2006</NOBR> at <NOBR>11:29</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P>Yey!! Oh wait, I’m an American, and thus have no use for international standards… &gt;.&lt;</P></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>Daniel Berger</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>24 Jul 2006</NOBR> at <NOBR>12:08</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P>I guess Tim Bray will have to update his slides for RubyConf 2006 now. :)</P></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>oliver</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>24 Jul 2006</NOBR> at <NOBR>12:31</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P>When installing the gem I get the following error on  OS X . Any ideas?</P>


Besides, this seems what I have been looking for a long time. :)
<PRE><CODE>
Attempting local installation of 'character-encodings'
Local gem file not found: character-encodings*.gem
Attempting remote installation of 'character-encodings'
Updating Gem source index for: http://code.whytheluckystiff.net
Building native extensions.  This could take a while...
cc1: warnings being treated as errors
properties.c: In function ‘remove_all_combining_dot_above’:
properties.c:571: warning: control reaches end of non-void function
make: *** [properties.o] Error 1
cc1: warnings being treated as errors
properties.c: In function ‘remove_all_combining_dot_above’:
properties.c:571: warning: control reaches end of non-void function
make: *** [properties.o] Error 1
ruby extconf.rb install character-encodings --source code.whytheluckystiff.net
</CODE></PRE></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>13</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>24 Jul 2006</NOBR> at <NOBR>12:35</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P>oliver: Same here (using Ubuntu) :(</P></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>psmith</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>24 Jul 2006</NOBR> at <NOBR>12:40</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><STRONG>oliver:</STRONG> I had to apply this diff to get it to compile:
<PRE><CODE>
--- ext/encoding/character/utf-8/extconf.rb.orig        2006-07-24 13:24:39.000000000 -0500
+++ ext/encoding/character/utf-8/extconf.rb     2006-07-24 13:25:01.000000000 -0500
@@ -22,7 +22,6 @@
 try_compiler_option('-Wundef')
 try_compiler_option('-Wpointer-arith')
 try_compiler_option('-Wcast-align')
-try_compiler_option('-Werror')
 # XXX: sadly, -Wshadow is a bit too strict.  It will, for example, whine about
 # local variables called “index” on FreeBSD.
 # try_compiler_option('-Wshadow')
</CODE></PRE>Then I had to manually copy the utf8.bundle to the lib/encoding/character directory and apply this diff:
<PRE><CODE>
--- lib/encoding/character/utf-8.rb.orig        2006-07-24 13:29:23.000000000 -0500
+++ lib/encoding/character/utf-8.rb     2006-07-24 13:34:25.000000000 -0500
@@ -2,7 +2,7 @@
 #
 # Copyright © 2006 Nikolai Weibull &lt;now@bitwi.se&gt;

-require 'encoding/character/utf-8/utf8.so'
+require 'encoding/character/utf8.bundle'

 # TODO: Rework this to use a dispatch object instead, so that the encoding can
 # be changed on the fly.
</CODE></PRE></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>FlashHaterHater</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>24 Jul 2006</NOBR> at <NOBR>12:53</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P>Damn straight. Why do you think so many people in other countries speak English?</P></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>why</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>24 Jul 2006</NOBR> at <NOBR>12:54</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P>Okay, the gem is updated to turn off <CODE>-Werror</CODE> for now.</P></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>psmith</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>24 Jul 2006</NOBR> at <NOBR>12:59</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><PRE><CODE>
irb(main):001:0&gt; require 'encoding/character/utf-8'
=&gt; true
irb(main):002:0&gt; str = u"hëllö" 
=&gt; u"h\303\253ll\303\266" 
irb(main):003:0&gt; str.size
=&gt; 7
irb(main):004:0&gt; RUBY_VERSION
=&gt; "1.8.4" 
irb(main):005:0&gt; RUBY_PLATFORM
=&gt; "i686-darwin8.6.2" 
</CODE></PRE></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>why not</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>24 Jul 2006</NOBR> at <NOBR>13:49</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P>Why not just return what the function should??</P>


	<P>At the end of remove_all_combining_dot_above(), either:
return decomp_len;
or:
return 0;</P>


	<P>...as appropriate (I believe that with -Werror off, it’ll return 0). Probably the latter, but I’m having trouble parsing the function, so I can’t be sure.</P></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>nil</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>24 Jul 2006</NOBR> at <NOBR>14:50</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P>but everyone will speak ruby as the offical language of the rubiverse! :)</P></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>sporkmonger</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>24 Jul 2006</NOBR> at <NOBR>15:11</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P>How is it at dealing with unicode normalization?</P></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>Manfred</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>24 Jul 2006</NOBR> at <NOBR>16:49</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P>Length returns the number of codepoints, not what we would think of as ‘characters’. Using  NFC  or  NFKC  doesn’t solve this either because there are a lot of characters which can’t be composed.</P>


	<P>The solution for this is ‘grapheme clusters’, described in the unicode standard annex 29. The suggested implementation in the annex covers most of the characters used in everyday life.</P>


	<P>It looks like Nicolai didn’t implement this.</P></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>nweibull</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>24 Jul 2006</NOBR> at <NOBR>17:46</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P>OK, to everyone on  OS X , I’ve now updated the require to read <CODE>require 'encoding/character/utf-8/utf8'</CODE>, so Ruby should be able to figure out the extension for itself.</P>


	<P>Second, about the whole -Werror and -W stuff, sorry.  For some reason, my compiler (gcc 3.4.6) didn’t report the “non-void without return” error.  I’ll have to look into that.  It’s good that I didn’t disable -Werror, however, as it was a horrible bug.  The code has been fixed now.  (Update, it’s the -std=c99 that does it.  I have no explanation for this behavior – it seems that the c99 code generator will fill in the return instruction anyway – I’ll upgrade to 4.1 soon.)</P>


	<P>About <CODE>#size</CODE>: it’s not overriden, so it’ll return the number of bytes in the string.  I don’t know if that makes sense at all, but that’s how it currently works.  Perhaps an addition of #byte_length makes more sense.</P>


	<P><STRONG>sporkmonger</STRONG>: Good, although there’s no Ruby interface for it yet.  I’ll add a method for normalization tomorrow.</P>


	<P><STRONG>Manfred</STRONG>: Ni/k/olai, if you please.  And you are definitely right about “grapheme clusters”.  It’s certainly something that is worth supporting.  However, normalization does cover a lot of the everyday cases, so it’s not like we can’t do without “grapheme clusters” either.</P>


	<P>I guess next on the list is to create a rubyforge project so that we can have a mailing list instead of discussing everything here.</P></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>oliver</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>25 Jul 2006</NOBR> at <NOBR>00:48</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P>Nikolai: Thanks, for doing the  OS X  bugfix.</P>


	<P>I am looking forward to the rubyforge project.</P></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>Manfred</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>25 Jul 2006</NOBR> at <NOBR>01:49</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P><STRONG>Nikolai</STRONG>: Oops, sorry I misspelled your name. I would love to see a mailing list to discuss some things (:</P></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>Manfred</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>25 Jul 2006</NOBR> at <NOBR>03:52</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P>Sorry, but I have to comment some more.</P>


	<P>Normalizing a string is not enough to “cover a lot of the everyday cases” there are a <EM>lot</EM> of characters which can’t be composed. Nikolai’s utf-8 library doesn’t expose normalization yet, so I’m using an alternative library for this example:</P>


<PRE>&lt;cpde&gt;c = [0xFB1D].pack('U') # HEBREW LETTER YOD WITH HIRIQ
c.chars.length #=&gt; 1
c = c.chars.normalize_D
c.unpack('U*').length #=&gt; 2
c = c.chars.normalize_KC
c.unpack('U*').length #=&gt; 2</PRE>

	<P>Even though everybody would agree that this is one character, slicing between these codepoints will leave us with a different character than we started with. In German for some words the difference between singular and plural form is an Umlaut, if we chop this accent off with a broken slice we significantly change the meaning of the text.</P>


	<P>The other problem with this solution is that it modifies the string methods, <EM>every</EM> ruby programs expects the length method to return the length in bytes. Consider this:</P>


<PRE><CODE>str = u"hëllö" 
headers &lt;&lt; "Content-length: #{str.length}"</CODE></PRE>

	<P>I’ve ran into this in the past myself and believe me, it wreaks havoc in Webrick.</P></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>nweibull</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>25 Jul 2006</NOBR> at <NOBR>04:52</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P><STRONG>Manfred</STRONG>: There’s always <CODE>#size</CODE>, which remains unchanged.  But please do come with a suggestion that makes both length easily accessible (and perhaps the third, the number of grapheme clusters…).  I agree that overriding methods do have some negative consequences as well.  Of course, the methods are overriden on a per-object basis, so in your example above, you, as a developer, should be aware that when you say that <CODE>str</CODE> is a  UTF -8-encoded string, <CODE>#length</CODE> will not return the <EM>number of bytes</EM> in <CODE>str</CODE>, but rather the <EM>number of codepoints</EM> in <CODE>str</CODE>.</P>


	<P><STRONG>All</STRONG>: There’s now a <A href="http://rubyforge.org/projects/char-encodings/">Rubyforge project</A> set up for the character-encodings library.</P>


	<P>There’s a mailing list, called char-encodings-development, which isn’t active yet.  Hopefully Tom will get it set up sooner rather than later :-).</P></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>will</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>25 Jul 2006</NOBR> at <NOBR>07:31</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P>nweibull, intuitively #size would return the length in bytes and #length should return the ‘character’ length for me.</P></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>Boris K</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>25 Jul 2006</NOBR> at <NOBR>07:34</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P>This is great work. Thank you Nikolai, thank you _why.</P></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>Object</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>26 Jul 2006</NOBR> at <NOBR>12:39</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><CODE>
<PRE>def language_spoken(date) 
  date &gt; Date.today ? 'ruby' : 'utf-8'
end
</PRE>
</CODE></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>MenTaLguY</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>26 Jul 2006</NOBR> at <NOBR>15:45</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P><STRONG>Nikolai</STRONG>: The problem really isn’t that you’ve got to convince ruby developers that <CODE>String#length</CODE> doesn’t mean the same thing as it normally does, it’s that you’ve potentially got to convince every piece of Ruby code ever written.</P>


	<P>I can see a change like this between, say, Ruby 1.8 and 1.9.  I’ve got a harder time justifying it for a library.  Does 1.9 at least have a similar change, by the way?</P></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>nweibull</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>26 Jul 2006</NOBR> at <NOBR>15:57</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P><STRONG>MenTaLguY</STRONG>: Well, it all depends.  I again stress that this is on a per-object level, so it won’t change anything unless you explicitly tell it to, which means that changing the meaning of <CODE>String#length</CODE> isn’t all that drastic after all.  However, often when you mean when you say <CODE>String#width</CODE>, or perhaps you actually want to take grapheme clusters into account, so it’s all rather fuzzy as it is.</P></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>MonkeeSage</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>27 Jul 2006</NOBR> at <NOBR>07:48</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P>It seems to me that the Right Thing to Do is to mixin methods to the String class globally rather than on a per-object basis, adding a “u” prefix (“ulength”, “ureverse”, &amp;c).</P>


Pros:
	<UL>
	<LI>A clear distinction betwen byte-oriented and charcter-oriented methods.</LI>
		<LI>No need to initialize strings with a special method (e.g., “u()” or ”+”)—all strings are potentially  UTF  strings, the only time that comes into play is when the “u”-methods are called.</LI>
		<LI>One can always use the “u”-methods in a mixed-data context, just to be safe, as they work for  UTF  only ordinals and the  ASCII  subset, but still have access to the old byte methods.</LI>
		<LI>Existing programs won’t break.</LI>
	</UL>


Cons:
	<UL>
	<LI>The bracket-accessor method “[]” – should some kind of “at” method be used instead (“uat()”), in order to preserve the byte-based indexing using this method but still allow character-based indexing? Other similar questions.</LI>
		<LI>One has to remember to use the “u”-method versions (I’m sure that would bite me from time to time).</LI>
	</UL>


	<P>There may be other pros/cons, but those are the ones I could think of.</P></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>nweibull</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>27 Jul 2006</NOBR> at <NOBR>13:12</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P><STRONG>MonkeeSage</STRONG>: I don’t think that’s an appropriate solution, as I want to keep it as true to the idea of Strings in Rite as possible, i.e., every string has an encoding.  The encoding can be accessed through #encoding, and I do think that it would be worth-wile to be able to change the encoding on the fly for any given string.  That way you can easily switch between treating a string as a sequence of bytes, and something more advanced such as  UTF -8,  UTF -16, or some such.  That way I think one solves the problem without changing the interface per se.</P>


	<P>Remember, the only reason #length returns the length of the string in bytes is because that’s the way it is currently implemented.  Having to live with such a restriction for all eternity seems rather silly.</P></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>MonkeeSage</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>28 Jul 2006</NOBR> at <NOBR>09:00</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P><STRONG>Nikolai:</STRONG> I think aiming for Rite compatibility is probably a good idea. Personally though, I’m still not sure I like the idea of an encoding associated with every string by default, even if it is adopted by Matz for Ruby2 (not much I can do about that though!).</P>


	<P> IMO , all strings should be thought of simply as groups of bytes on the basic class level (and offer byte-level access). The where and what of those groupings and so forth should come in at the level of manipulating them, i.e., through methods or subclasses or modules. It would be very easy to have, e.g., EncodedString &lt; String, which you have to initialize with a method that takes an encoding and has methods for manipulating and translating encoded strings and adds an encoding attr.</P>


	<P>Anyhow, implementation gripes aside, I appreciate the work you’re doing, please keep it up!</P></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>why</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>28 Jul 2006</NOBR> at <NOBR>11:09</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P><STRONG>MonkeeSage:</STRONG> It seems like the distinction between your approach and Nikolai’s is really very minor.  Nikolai is storing a byte string underneath it all.</P>


<PRE> &gt;&gt; require 'encoding/charater/utf-8'
 &gt;&gt; gem = u(File.read("sources-0.0.1.gem"))
 &gt;&gt; gem.size
 =&gt; 3072
 &gt;&gt; gem.length
 =&gt; 2941
 &gt;&gt; gem.normalize
 =&gt; u"data.tar.gz" 

 &gt;&gt; require 'stringio'
 &gt;&gt; StringIO.new(gem).read
 =&gt; "data.tar.gz\000\000\000\000\000\000..." 
</PRE>

	<P>But, yeah, Nikolai’s storming right into the class and overriding all kinds of methods.  I don’t know if Matz wants <CODE>length</CODE> and <CODE>size</CODE> to be different, but it makes pretty good sense to me.</P></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>MonkeeSage</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>28 Jul 2006</NOBR> at <NOBR>13:57</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P>I suppose I could always do something like:</P>


<PRE><CODE>
require('encoding/character/utf-8')
class String
  def method_missing(m, *args)
    if (m.to_s[0,1] == 'u')
      u(self).method(m.to_s[1..-1]).call(*args)
    else
      raise(NoMethodError, "No method `#{m}'", caller)
    end
  end
end
puts('h&amp;#235;ll&amp;#246;'.ureverse)
puts('h&amp;#235;ll&amp;#246;'.uupcase)
</CODE></PRE>

	<P>:)</P></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>MonkeeSage</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>28 Jul 2006</NOBR> at <NOBR>13:59</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P>err… hëllö -&gt; hëllö</P></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>MonkeeSage</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>28 Jul 2006</NOBR> at <NOBR>14:01</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P>one more time… <CODE>h&amp;#235;ll&amp;#246;</CODE> -&gt; <CODE>hëllö</CODE></P></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>why</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>28 Jul 2006</NOBR> at <NOBR>15:31</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P>Yeah, see, that’s the spirit, MonkeeSage.</P></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>MonkeeSage</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>28 Jul 2006</NOBR> at <NOBR>17:06</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P>This is better…</P>


<PRE><CODE>
Encoding::Character::UTF8.methods.each do |m|
  String.class_eval(%!
    define_method("u#{m}") do |*args|
      Encoding::Character::UTF8.#{m}(self, *args)
    end
  !)
end
</CODE></PRE><CODE></CODE></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>MonkeeSage</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>28 Jul 2006</NOBR> at <NOBR>22:48</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P>Ok, so now I’m  DRY , I’m meta-tacular, and GC friendly (all thanks to redhanded)...</P>


<PRE><CODE>
require('encoding/character/utf-8')
def uStringMethods()
  umethods = []
  Encoding::Character::UTF8.methods.each do |m|
    umethods.push(%!
      define_method("u#{m}") do |*args|
        Encoding::Character::UTF8.#{m}(self, *args)
      end
    !)
  end
  String.class_eval(umethods.join)
end
uStringMethods
</CODE></PRE>

	<P>...now if I could just figure out what the heck an eigen is, I could make matrices and vectors and classes out of it…it would be like figuring out the secret recipe of the fluff in the fluffernutter…but that’s for another day.</P>


	<P><STRONG>Nikolai:</STRONG> I’m having trouble building off the latest head (are thre still heads and branches in git terminology?). I’m going to join the rubyforge list and post details there.</P></DIV></DIV>
</DIV>


<DIV class="entry">
<FORM name="userComment" method="post" action="/api/comment/inspect/nikolaiSUtf8LibIsAllReady">
  <DIV class="entryAttrib">
     <DIV class="entryAuthor"><INPUT name="sayor" type="textbox" size="15" maxlength="50"></DIV>
     <DIV id="liveTime" class="entryTime"><NOBR>11 Jul 2010</NOBR> at <NOBR>21:32</NOBR></DIV>
  </DIV>
  <DIV class="entryContentOuter"><DIV class="entryContent">
     <INPUT type="hidden" name="timestamp" value="yopYLare1A">
     <TEXTAREA name="consay" rows="6" cols="50"></TEXTAREA>
     <P><INPUT type="button" name="pleasePreview" value="preview" onclick="liveTextilePreview(document.forms[&#39;userComment&#39;].elements[&#39;consay&#39;], &#39;textilePreview&#39;, &#39;/api/preview&#39;)">
        <INPUT type="submit" name="submit" value="&gt;&gt;">
        <SMALL>* do <A href="../javascript:quickRedReference();">fancy stuff</A> in your comment.</SMALL>
     </P>
     <DIV id="textileWrap"><H4>PREVIEW PANE</H4>
     <DIV id="textilePreview"></DIV>
     </DIV>
     </DIV>
  </DIV></FORM></DIV>
  



        </DIV> 

</DIV>



</DIV>





</BODY></HTML>