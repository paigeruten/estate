<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "DTD/xhtml1-transitional.dtd">
<!-- saved from url=(0166)redhanded.hobix.com/inspect/theStoryOfStreamingHttpThroughMouseholeWithSubsequentAdventuresInContinuationsAndDuckTyping.html -->
<HTML xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><HEAD><META http-equiv="Content-Type" content="text/html; charset=UTF-8">
<!--<BASE href="http://redhanded.hobix.com.wstub.archive.org/inspect/theStoryOfStreamingHttpThroughMouseholeWithSubsequentAdventuresInContinuationsAndDuckTyping.html">--><BASE href=".">


<TITLE>RedHanded » The Story of Streaming HTTP Through MouseHole (With Subsequent Adventures in Continuations and Duck Typing)</TITLE>
<LINK rel="shortcut icon" href="../favicon.ico" type="image/vnd.microsoft.icon" />
<LINK rel="icon" href="../favicon.ico" type="image/vnd.microsoft.icon" />
<META http-equiv="Pragma" content="no-cache">
<META http-equiv="Expires" content="-1">




<STYLE type="text/css">
 @import "../site.css"; 
</STYLE>
</HEAD><BODY>

<DIV id="page">

<DIV id="hoodwinkd">
  <A href="http://hoodwinkd.hobix.com/"><SPAN>hoodwink.d enhanced</SPAN></A>

</DIV>
<DIV id="buttons">
<DL class="tab">
  <DT><A title="Syndicate this Site" href="index.xml">RSS</A></DT>
  <DD><A title="Syndicate this Site" href="index.xml">2.0</A></DD>
</DL>
<DL class="tab xhtml">
  <DT><A title="Validate this Site" href="http://validator.w3.org/check?uri=http://redhanded.hobix.com/">XHTML</A></DT>
  <DD><A title="Validate this Site" href="http://validator.w3.org/check?uri=http://redhanded.hobix.com/">1.0</A></DD>
</DL>
</DIV>
<H1 class="title"><A href="../"><IMG src="../images/redhanded.gif" alt="RedHanded"></A></H1>
<DIV id="banner">
  <DIV class="tagline">sneaking Ruby through the system</DIV>
  <DIV class="nav"><A href="../5.gets/">5.gets</A> | <A href="../bits/">bits</A> | 
    <A href="../inspect/">inspect</A> | <A href="../cult/">the cult</A> | <A href="../-h/">-h</A></DIV>
</DIV>


<DIV id="content">
<DIV id="sidebar">
<P>New to RedHanded? <A href="../-h/pardonAndWelcome.html">About our sections.</A></P>

<DIV class="sidebarBox">
<H2 class="sidebarTitle">Archive</H2>
<UL>

    <LI><A href="../2004/12/">December 2004</A></LI>

    <LI><A href="../2005/01/">January 2005</A></LI>

    <LI><A href="../2005/02/">February 2005</A></LI>

    <LI><A href="../2005/03/">March 2005</A></LI>

    <LI><A href="../2005/04/">April 2005</A></LI>

    <LI><A href="../2005/05/">May 2005</A></LI>

    <LI><A href="../2005/06/">June 2005</A></LI>

    <LI><A href="../2005/07/">July 2005</A></LI>

    <LI><A href="../2005/08/">August 2005</A></LI>

    <LI><A href="../2005/09/">September 2005</A></LI>

    <LI><A href="../2005/10/">October 2005</A></LI>

    <LI><A href="../2005/11/">November 2005</A></LI>

    <LI><A href="../2005/12/">December 2005</A></LI>

    <LI><A href="../2006/01/">January 2006</A></LI>

    <LI><A href="../2006/02/">February 2006</A></LI>

    <LI><A href="../2006/03/">March 2006</A></LI>

    <LI><A href="../2006/04/">April 2006</A></LI>

    <LI><A href="../2006/05/">May 2006</A></LI>

    <LI><A href="../2006/06/">June 2006</A></LI>

    <LI><A href="../2006/07/">July 2006</A></LI>

    <LI><A href="../2006/08/">August 2006</A></LI>

    <LI><A href="../2006/09/">September 2006</A></LI>

    <LI><A href="../2006/10/">October 2006</A></LI>

    <LI><A href="../2006/11/">November 2006</A></LI>

    <LI><A href="../2006/12/">December 2006</A></LI>

    <LI><A href="../2007/01/">January 2007</A></LI>

    <LI><A href="../2007/02/">February 2007</A></LI>

    <LI><A href="../2007/03/">March 2007</A></LI>

    <LI><A href="../2007/04/">April 2007</A></LI>

    <LI><A href="../2007/05/">May 2007</A></LI>

</UL>
</DIV>

<P><A href="http://www.pragmaticprogrammer.com/titles/ruby/index.html"><IMG src="../images/prag-ruby-book.jpg" alt="PickAxe II"></A><BR>
<A href="http://www.pragmaticprogrammer.com/titles/ruby/index.html">Get your copy of <I>Programming Ruby</I>!</A></P>

 <DIV class="sidebarBox">
        <H2 class="sidebarTitle">Links</H2>
        <A href="http://technorati.com/tags/ruby">@technorati</A><BR>
<A href="http://del.icio.us/tag/ruby">@del.icio.us</A><BR>
<A href="http://www.flickr.com/photos/tags/ruby">@flickr</A><BR>
<A href="http://www.artima.com/articles/index.jsp?topic=ruby">@artima</A><BR>
<A href="http://blog.caboo.se/">@caboo</A><BR>
<A href="http://www.oreillynet.com/ruby">@oreilly</A><BR>
<A href="http://ruby-lang.org/">ruby</A><BR>
<A href="http://ruby-doc.org/">-&gt; docs</A><BR>
<A href="http://rubyforge.org/">-&gt; wares</A><BR>
<A href="http://rubygarden.org/ruby/">-&gt; wiki</A><BR>
<A href="http://www.sitepoint.com/forums/forumdisplay.php?f=227">-&gt; forum</A><BR>
<A href="http://www.rubyquiz.com/">-&gt; quizzes</A><BR>
<A href="http://planetruby.0x42.net/">-&gt; planet</A><BR>
<A href="http://meme.b9.com/cdates.html?channel=ruby-lang">-&gt; irc</A><BR>
<A href="http://www.rubyweeklynews.org/">rubyweeklynews</A><BR>
<A href="http://weblog.rubyonrails.com/">rails</A><BR>
<A href="http://wiki.rubyonrails.org/">-&gt; wiki</A><BR>
<A href="http://www.planetrubyonrails.org/">-&gt; planet</A><BR>
<A href="http://thesaq.com/rubyonrails/">-&gt; irc</A><BR>
<A href="http://anarchaia.org/">%anarchaia</A><BR>
<A href="http://project.ioni.st/">%projectionist</A><BR>
<A href="http://pugs.blogs.com/">~audreyt</A><BR>
<A href="http://dablog.rubypal.com/">~black</A><BR>
<A href="http://www.jamesbritt.com/">~britt</A><BR>
<A href="http://www.jamisbuck.org/jamis/">~buck</A><BR>
<A href="http://tomcopeland.blogs.com/juniordeveloper/">~copeland</A><BR>
<A href="http://eigenclass.org/">~fernandez</A><BR>
<A href="http://www.chadfowler.com/">~fowler</A><BR>
<A href="http://www.loudthinking.com/">~hansson</A><BR>
<A href="http://blog.segment7.net/">~hodel</A><BR>
<A href="http://slash7.com/">~hoy/7</A><BR>
<A href="http://fhwang.net/">~hwang</A><BR>
<A href="http://blog.leetsoft.com/">~luetke</A><BR>
<A href="http://www.worldlingo.com/wl/translate?wl_lp=JA-en&wl_glossary=gl1&wl_fl=3&wl_rurl=http%3A%2F%2Fwww.rubyist.net%2F%7Ematz%2F&wl_url=http%3A%2F%2Fwww.rubyist.net%2F%7Ematz%2F&wl_g_table=-3">~matz</A><BR>
<A href="http://moonbase.rydia.net/">~mental</A><BR>
<A href="http://techno-weenie.net/">~olson</A><BR>
<A href="http://pragprog.com/pragdave">~pragdave</A><BR>
<A href="http://www.livejournal.com/users/premshree/">~premshree</A><BR>
<A href="http://kronavita.de/chris/blog/">~neukirchen</A><BR>
<A href="http://www.robbyonrails.com/">~robby</A><BR>
<A href="http://www.rousette.org.uk/">~rousette</A><BR>
<A href="http://nubyonrails.com/">~topfunky</A><BR>
<A href="http://www.jvoorhis.com/">~voorhis</A><BR>
<A href="http://onestepback.org/">~weirich</A><BR>
<A href="http://blog.zenspider.com/">~zenspider</A><BR>
        </DIV> 
 <DIV class="sidebarBox">
        <H2 class="sidebarTitle">Syndicate</H2>
        <UL>
            <LI><A href="../index.xml">RSS 2.0</A></LI>
        </UL>
        </DIV> 
 <DIV class="sidebarBox">
        <P>Built upon <A href="http://hobix.com/">Hobix</A></P>
        </DIV> 
<IMG src="../images/redhanded-duck.gif" alt="Type the Duck">
<DIV class="email">Got a story for us? <A href="../mailto:redhanded@hobix.com">E-mail it!</A></DIV>
<DIV class="technorati"><P><A href="http://www.technorati.com/profile/whytheluckystiff">Technorati Profile</A>
<A href="http://www.technorati.com/cosmos/search.html?url=http%3A%2F%2Fredhanded.hobix.com"><BR>
<IMG src="../images/bubble_icon.gif" height="20" width="24" alt="Get Conversations about RedHanded &raquo; sneaking Ruby through the system"></A>
</P>
</DIV>

</DIV>


 <DIV id="blog">
        
<DIV class="entry">
    <H2 class="entryTitle">The Story of Streaming HTTP Through MouseHole (With Subsequent Adventures in Continuations and Duck Typing)
  <SPAN class="entryPermalink"><A href="../inspect/theStoryOfStreamingHttpThroughMouseholeWithSubsequentAdventuresInContinuationsAndDuckTyping.html" title="Permanent link to &ldquo;The Story of Streaming HTTP Through MouseHole (With Subsequent Adventures in Continuations and Duck Typing)&rdquo;">#</A></SPAN>
</H2>

<DIV class="entrySection">by <A href="http://whytheluckystiff.net/" title="Visit why&#39;s homepage">why</A> 
  in <A href="../inspect" title="List of entries in the &ldquo;inspect&rdquo; category">inspect</A>
</DIV>

     <DIV class="entryContent"><P>Hacking MouseHole has been considerably fun and challenging, especially since much of the work involves subclassing and reshaping existing classes.  It’s like glass blowing.  Overriding methods here and there, but holding on to the underlying class as much as possible.</P>


	<P>(<EM>If you’re new, MouseHole is an idea conceived by the readers of this blog: a scriptable proxy for rewriting the web and sharing little web applications.  <A href="http://mousehole.rubyforge.org/">The wiki</A> goes into detail.</EM>)</P>


	<P>I’m sure one of the things that deters many from using MouseHole is the word <STRONG>proxy</STRONG>.  No one wants to hinder their browsing with longer wait times while a proxy gets its act together.  Cleaning the <SPAN class="caps">HTML</SPAN>, parsing it, rewriting it, rebuilding it.  Sounds like a lot.</P>


	<P>So, I’ve been working on adding streaming support to the proxy.  So downloads will get a progress bar in the browser.  And so that images, css, unhandled pages, etc. will travel through the proxy quicker.  It’s working well, much improvement, but just a couple notes on what it took.</P>


	<H2>The Net::HTTP and WEBrick Cable</H2>


	<P>At heart, the <CODE>WEBrick::HTTPProxy</CODE> uses a bit of code to pass its request onto the web and then hand it back to the browser.  Trimming out a bit of cruft, it looks like this:</P>


<PRE class="ruby"> begin
   http = Net::HTTP.new(uri.host, uri.port, proxy_host, proxy_port)
   http.start{
     case req.request_method
     when "GET"  then response = http.get(path, header)
     when "POST" then response = http.post(path, req.body || "", header)
     when "HEAD" then response = http.head(path, header)
     else
       raise HTTPStatus::MethodNotAllowed,
         "unsupported method `#{req.request_method}'." 
     end
   }
 rescue =&gt; err
   logger.debug("#{err.class}: #{err.message}")
     raise HTTPStatus::ServiceUnavailable, err.message
 end

 # Convert Net::HTTP::HTTPResponse to WEBrick::HTTPProxy
 res.status = response.code.to_i
 choose_header(response, res)
 set_cookie(response, res)
 set_via(res)
 res.body = response.body

 # Process contents
 if handler = @config[:ProxyContentHandler]
   handler.call(req, res)
 end
</PRE>

	<P>So three things:</P>


	<OL>
	<LI>Use Net::HTTP to retrieve the resource from the web.</LI>
		<LI>Convert the response to WEBrick’s own response object type.</LI>
		<LI>Pass the response to a handler, if one is setup.</LI>
	</OL>


	<P>In the case of MouseHole: yes, we’ve got a handler.  Our handler checks to see if a MouseHole script wants to mess with the resource.</P>


	<P>Now, how do we add streaming to this?  The above code is using <CODE>Net::HTTP</CODE> to download the whole resource before moving on.  We can’t have this.  We want to just get the headers and let the handler decide what to do with the response body.</P>


	<P>One other thing about WEBrick that I discovered: if you give it a response where the <CODE>@body</CODE> is an IO object, it’ll stream that object to the output.  Perfect, right?</P>


	<H2>Pulling the Thread That Goes Back in Time</H2>


	<P>Digging around in the <CODE>Net::HTTP</CODE> code was taking forever and I really wanted to get something working.  So I thought I’d try wrapping a <CODE>Generator</CODE> around the whole thing.</P>


	<P>In my subclass of the proxy, I overrode the method containing the above code with:</P>


<PRE class="ruby"> response = nil
 begin
   http = Net::HTTP.new(uri.host, uri.port, proxy_host, proxy_port)
   g = Generator.new do |g|
     http.start do
       chunkd = proc do |gres|
         g.yield gres
         gres.read_body do |gstr|
           g.yield gstr
         end
       end
       case req.request_method
       when "GET"  then http.request_get(path, header, &amp;chunkd)
       when "POST" then http.request_post(path, req.body || "", header, &amp;chunkd)
       when "HEAD" then http.request_head(path, header, &amp;chunkd)
       else
         raise WEBrick::HTTPStatus::MethodNotAllowed,
           "unsupported method `#{req.request_method}'." 
       end
     end
   end

   # Use the generator to mimick an IO object
   def g.read sz = 0; next? ? self.next : nil end
   def g.size; 0 end
   def g.close; while next?; self.next; end end
   def g.is_a? klass; klass == IO ? true : super(klass); end
 rescue =&gt; err
   logger.debug("#{err.class}: #{err.message}")
     raise WEBrick::HTTPStatus::ServiceUnavailable, err.message
 end

 response = g.next

 # Convert Net::HTTP::HTTPResponse to WEBrick::HTTPProxy
 res.status = response.code.to_i
 choose_header(response, res)
 set_cookie(response, res)
 set_via(res)
 res.body = g
 def res.send_body(socket)
   if @body.respond_to? :read
     send_body_io(socket)
   else 
     send_body_string(socket)
   end
 end

 # Process contents
 if handler = @config[:ProxyContentHandler]
   handler.call(req, res)
 end
</PRE>

	<P>This is a ridiculous hack.  Maybe.  When the generator is created, the code inside isn’t executed.  It all gets skipped.  But when I run <CODE>g.next</CODE>, the code whirs into motion.  And the first <CODE>yield</CODE> passes us a response at the moment the headers are parsed, but before the body has been read.</P>


	<P>The hackiness has to do with getting WEBrick to actually accept the generator as an IO object.  Naturally, there has to be a <CODE>read</CODE> method, which just calls <CODE>next</CODE> to get chunks of the stream.  Adding <CODE>size</CODE> and <CODE>close</CODE> methods made sense as well.  But I actually has to override <CODE>is_a?</CODE> to let my duck-typed generator pass through.  Ugghh.</P>


	<P>Overall, it works well.  I didn’t even notice much slowness.  Until memory got gobbled up.  Which happens rather quickly with continuations.</P>


	<H2>Punching Holes in Net:HTTP</H2>


	<P>Now that I had a decent angle on this, I decided to take a different approach: to rework Net::HTTP as an IO object.  I would have loved to use <CODE>OpenURI</CODE> but it doesn’t support all the <SPAN class="caps">HTTP</SPAN> request methods.  Also, <CODE>http-access2</CODE> seemed to have the same problems as <CODE>Net::HTTP</CODE>.</P>


	<P>The problem is that <CODE>Net::HTTP</CODE> will only work as a stream when it’s given a block.  If no block is given, the whole stream is read into memory and returned.</P>


	<P>The gist of the hack is this:</P>


<PRE> require 'net/http'
 module Net
 class HTTPIO &lt; HTTP
   def request(req, body = nil, &amp;block)
     begin_transport req
     req.exec @socket, @curr_http_version, edit_path(req.path), body
     begin
       res = HTTPResponse.read_new(@socket)
     end while HTTPContinue === res

     res.instance_eval do
       def read len = nil; ... end
       def body; true end
       def close
         req, res = @req, self
         @http.instance_eval do
            end_transport req, res
            finish
         end
       end
       def size; 0 end
       def is_a? klass; klass  IO ? true : super(klass); end
     end

     res
   end
 end
</PRE>

	<P>Since all the request methods route through <CODE>Net::HTTP#request</CODE>, it was just a matter of replacing that method.  We’ve come to expect this in object-oriented languages.  But what pushes the lever further in Ruby is how I can also redefine portions of the <CODE>HTTPResponse</CODE> object (using singleton methods), reshape it without needing to affect its original class.</P>


	<P>In all, I feel like some of the same old good practices could have facilitated the hack easier:</P>


	<UL>
	<LI>Please, no <CODE>is_a?</CODE> or <CODE>=</CODE> tests for IO objects.  Duck type: use <CODE>input.respond_to? :read</CODE>.</LI>
		<LI>If you have a streaming IO class, don’t require a block in order to stream.  I might need to take that stream out of scope with me.  Also, what if I need to start and stop the stream?</LI>
	</UL>


	<P>In the end, I’m left pretty guilty myself.  I’ve hacked classes for my own use but they’re pretty worthless outside of MouseHole.  I gotta find a way to push this back into the original classes or something.</P></DIV> 
</DIV>
<DIV class="entryFooter"> 
    <NOBR>13 Oct 2005</NOBR> at <NOBR>11:53</NOBR>
    <NOSCRIPT></NOSCRIPT>
   | 
    3 comments
</DIV>
</DIV>
<DIV id="comments">


<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>Kevin Ballard</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>13 Oct 2005</NOBR> at <NOBR>14:46</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P>Hey why, can you please add syntax colorizing to your code here? It sure would make it easier to read.</P></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>MrCode</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>13 Oct 2005</NOBR> at <NOBR>14:53</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P>Well it is like they say, you can never predict the strange way customers will use your products. In this case you are the customer and the product is Net::HTTP. I agree that using respond_to? is better than is_a?, and clearly here we have a good example of why.</P>


	<P>Ruby in particular is possibly more “vulnerable to customer hacks” than other languages, because of how the classes are open. So you might as well write your code to be as flexible as possible.</P>


	<P> BTW , this is all pretty impressive with the streaming and all. I took a quick look in the Wonderland days and it seemed tricky.</P></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>mu's</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>14 Oct 2005</NOBR> at <NOBR>10:07</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P>baffle! wooaang!</P></DIV></DIV>
</DIV>


  <DIV class="entry">
    <P><SMALL>Comments are closed for this entry.</SMALL></P>
  



        </DIV> 

</DIV>



</DIV>





</DIV></BODY></HTML>