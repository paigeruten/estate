<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "DTD/xhtml1-transitional.dtd">
<!-- saved from url=(0098)redhanded.hobix.com/inspect/muckingWithUnicodeFor18.html -->
<HTML xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><HEAD><META http-equiv="Content-Type" content="text/html; charset=UTF-8">
<!--<BASE href="http://redhanded.hobix.com.wstub.archive.org/inspect/muckingWithUnicodeFor18.html">--><BASE href=".">


<TITLE>RedHanded » Mucking With Unicode for 1.8</TITLE>
<LINK rel="shortcut icon" href="../favicon.ico" type="image/vnd.microsoft.icon" />
<LINK rel="icon" href="../favicon.ico" type="image/vnd.microsoft.icon" />
<META http-equiv="Pragma" content="no-cache">
<META http-equiv="Expires" content="-1">




<STYLE type="text/css">
 @import "../site.css"; 
</STYLE>
</HEAD><BODY>

<DIV id="page">

<DIV id="hoodwinkd">
  <A href="http://hoodwinkd.hobix.com/"><SPAN>hoodwink.d enhanced</SPAN></A>

</DIV>
<DIV id="buttons">
<DL class="tab">
  <DT><A title="Syndicate this Site" href="index.xml">RSS</A></DT>
  <DD><A title="Syndicate this Site" href="index.xml">2.0</A></DD>
</DL>
<DL class="tab xhtml">
  <DT><A title="Validate this Site" href="http://validator.w3.org/check?uri=http://redhanded.hobix.com/">XHTML</A></DT>
  <DD><A title="Validate this Site" href="http://validator.w3.org/check?uri=http://redhanded.hobix.com/">1.0</A></DD>
</DL>
</DIV>
<H1 class="title"><A href="../"><IMG src="../images/redhanded.gif" alt="RedHanded"></A></H1>
<DIV id="banner">
  <DIV class="tagline">sneaking Ruby through the system</DIV>
  <DIV class="nav"><A href="../5.gets/">5.gets</A> | <A href="../bits/">bits</A> | 
    <A href="../inspect/">inspect</A> | <A href="../cult/">the cult</A> | <A href="../-h/">-h</A></DIV>
</DIV>


<DIV id="content">
<DIV id="sidebar">
<P>New to RedHanded? <A href="../-h/pardonAndWelcome.html">About our sections.</A></P>

<DIV class="sidebarBox">
<H2 class="sidebarTitle">Archive</H2>
<UL>

    <LI><A href="../2004/12/">December 2004</A></LI>

    <LI><A href="../2005/01/">January 2005</A></LI>

    <LI><A href="../2005/02/">February 2005</A></LI>

    <LI><A href="../2005/03/">March 2005</A></LI>

    <LI><A href="../2005/04/">April 2005</A></LI>

    <LI><A href="../2005/05/">May 2005</A></LI>

    <LI><A href="../2005/06/">June 2005</A></LI>

    <LI><A href="../2005/07/">July 2005</A></LI>

    <LI><A href="../2005/08/">August 2005</A></LI>

    <LI><A href="../2005/09/">September 2005</A></LI>

    <LI><A href="../2005/10/">October 2005</A></LI>

    <LI><A href="../2005/11/">November 2005</A></LI>

    <LI><A href="../2005/12/">December 2005</A></LI>

    <LI><A href="../2006/01/">January 2006</A></LI>

    <LI><A href="../2006/02/">February 2006</A></LI>

    <LI><A href="../2006/03/">March 2006</A></LI>

    <LI><A href="../2006/04/">April 2006</A></LI>

    <LI><A href="../2006/05/">May 2006</A></LI>

    <LI><A href="../2006/06/">June 2006</A></LI>

    <LI><A href="../2006/07/">July 2006</A></LI>

    <LI><A href="../2006/08/">August 2006</A></LI>

    <LI><A href="../2006/09/">September 2006</A></LI>

    <LI><A href="../2006/10/">October 2006</A></LI>

    <LI><A href="../2006/11/">November 2006</A></LI>

    <LI><A href="../2006/12/">December 2006</A></LI>

    <LI><A href="../2007/01/">January 2007</A></LI>

    <LI><A href="../2007/02/">February 2007</A></LI>

    <LI><A href="../2007/03/">March 2007</A></LI>

    <LI><A href="../2007/04/">April 2007</A></LI>

    <LI><A href="../2007/05/">May 2007</A></LI>

</UL>
</DIV>

<P><A href="http://www.pragmaticprogrammer.com/titles/ruby/index.html"><IMG src="../images/prag-ruby-book.jpg" alt="PickAxe II"></A><BR>
<A href="http://www.pragmaticprogrammer.com/titles/ruby/index.html">Get your copy of <I>Programming Ruby</I>!</A></P>

 <DIV class="sidebarBox">
        <H2 class="sidebarTitle">Links</H2>
        <A href="http://technorati.com/tags/ruby">@technorati</A><BR>
<A href="http://del.icio.us/tag/ruby">@del.icio.us</A><BR>
<A href="http://www.flickr.com/photos/tags/ruby">@flickr</A><BR>
<A href="http://www.artima.com/articles/index.jsp?topic=ruby">@artima</A><BR>
<A href="http://blog.caboo.se/">@caboo</A><BR>
<A href="http://www.oreillynet.com/ruby">@oreilly</A><BR>
<A href="http://ruby-lang.org/">ruby</A><BR>
<A href="http://ruby-doc.org/">-&gt; docs</A><BR>
<A href="http://rubyforge.org/">-&gt; wares</A><BR>
<A href="http://rubygarden.org/ruby/">-&gt; wiki</A><BR>
<A href="http://www.sitepoint.com/forums/forumdisplay.php?f=227">-&gt; forum</A><BR>
<A href="http://www.rubyquiz.com/">-&gt; quizzes</A><BR>
<A href="http://planetruby.0x42.net/">-&gt; planet</A><BR>
<A href="http://meme.b9.com/cdates.html?channel=ruby-lang">-&gt; irc</A><BR>
<A href="http://www.rubyweeklynews.org/">rubyweeklynews</A><BR>
<A href="http://weblog.rubyonrails.com/">rails</A><BR>
<A href="http://wiki.rubyonrails.org/">-&gt; wiki</A><BR>
<A href="http://www.planetrubyonrails.org/">-&gt; planet</A><BR>
<A href="http://thesaq.com/rubyonrails/">-&gt; irc</A><BR>
<A href="http://anarchaia.org/">%anarchaia</A><BR>
<A href="http://project.ioni.st/">%projectionist</A><BR>
<A href="http://pugs.blogs.com/">~audreyt</A><BR>
<A href="http://dablog.rubypal.com/">~black</A><BR>
<A href="http://www.jamesbritt.com/">~britt</A><BR>
<A href="http://www.jamisbuck.org/jamis/">~buck</A><BR>
<A href="http://tomcopeland.blogs.com/juniordeveloper/">~copeland</A><BR>
<A href="http://eigenclass.org/">~fernandez</A><BR>
<A href="http://www.chadfowler.com/">~fowler</A><BR>
<A href="http://www.loudthinking.com/">~hansson</A><BR>
<A href="http://blog.segment7.net/">~hodel</A><BR>
<A href="http://slash7.com/">~hoy/7</A><BR>
<A href="http://fhwang.net/">~hwang</A><BR>
<A href="http://blog.leetsoft.com/">~luetke</A><BR>
<A href="http://www.worldlingo.com/wl/translate?wl_lp=JA-en&wl_glossary=gl1&wl_fl=3&wl_rurl=http%3A%2F%2Fwww.rubyist.net%2F%7Ematz%2F&wl_url=http%3A%2F%2Fwww.rubyist.net%2F%7Ematz%2F&wl_g_table=-3">~matz</A><BR>
<A href="http://moonbase.rydia.net/">~mental</A><BR>
<A href="http://techno-weenie.net/">~olson</A><BR>
<A href="http://pragprog.com/pragdave">~pragdave</A><BR>
<A href="http://www.livejournal.com/users/premshree/">~premshree</A><BR>
<A href="http://kronavita.de/chris/blog/">~neukirchen</A><BR>
<A href="http://www.robbyonrails.com/">~robby</A><BR>
<A href="http://www.rousette.org.uk/">~rousette</A><BR>
<A href="http://nubyonrails.com/">~topfunky</A><BR>
<A href="http://www.jvoorhis.com/">~voorhis</A><BR>
<A href="http://onestepback.org/">~weirich</A><BR>
<A href="http://blog.zenspider.com/">~zenspider</A><BR>
        </DIV> 
 <DIV class="sidebarBox">
        <H2 class="sidebarTitle">Syndicate</H2>
        <UL>
            <LI><A href="../index.xml">RSS 2.0</A></LI>
        </UL>
        </DIV> 
 <DIV class="sidebarBox">
        <P>Built upon <A href="http://hobix.com/">Hobix</A></P>
        </DIV> 
<IMG src="../images/redhanded-duck.gif" alt="Type the Duck">
<DIV class="email">Got a story for us? <A href="../mailto:redhanded@hobix.com">E-mail it!</A></DIV>
<DIV class="technorati"><P><A href="http://www.technorati.com/profile/whytheluckystiff">Technorati Profile</A>
<A href="http://www.technorati.com/cosmos/search.html?url=http%3A%2F%2Fredhanded.hobix.com"><BR>
<IMG src="../images/bubble_icon.gif" height="20" width="24" alt="Get Conversations about RedHanded &raquo; sneaking Ruby through the system"></A>
</P>
</DIV>

</DIV>


 <DIV id="blog">
        
<DIV class="entry">
    <H2 class="entryTitle">Mucking With Unicode for 1.8
  <SPAN class="entryPermalink"><A href="../inspect/muckingWithUnicodeFor18.html" title="Permanent link to &ldquo;Mucking With Unicode for 1.8&rdquo;">#</A></SPAN>
</H2>

<DIV class="entrySection">by <A href="http://whytheluckystiff.net/" title="Visit why&#39;s homepage">why</A> 
  in <A href="../inspect" title="List of entries in the &ldquo;inspect&rdquo; category">inspect</A>
</DIV>

     <DIV class="entryContent"><P>The idea here with this little project is to enhance the strings in Ruby 1.8 to support encodings.  Following the <A href="../inspect/futurismUnicodeInRuby.html">plan of Matz</A> and without breaking extensions and still allowing raw strings.</P>


	<P>For now, you have to specify the encoding when you create the string:</P>


<PRE> &gt;&gt; str = utf8("色は匂へど 散りぬるを")
 &gt;&gt; str[1,2]
 =&gt; は匂
 &gt;&gt; str[/散(.{2})/u, 1]
 =&gt; りぬ
</PRE>

	<P>I can’t use <CODE>wchar</CODE>, since I’m adding onto the <CODE>RString</CODE> class, which stores the raw bytes in <CODE>RSTRING(str)-&gt;ptr</CODE>.  And I’ve got to hook into Ruby’s regexps, can’t ignore that.  So, instead, I’ve added an indexed array of character lengths.  I’m not suggesting this is the answer, but consider that we have <A href="http://raa.ruby-lang.org/cat.rhtml?category_major=Library;category_minor=I18N">so little out there</A>.  When the string initially gets stored, it gets validated against the rules for the encoding and all the character sizes get stored.</P>


<PRE> &gt;&gt; require 'wordy'
 &gt;&gt; utf8("ვეპხის ტყაოსანი").index_s
 =&gt; [3, 3, 3, 3, 3, 3, 1, 3, 3, 3, 3, 3, 3, 3, 3]
</PRE>

	<P>The <CODE>index_s</CODE> method gives a list of the byte sizes for each character.  I only support <SPAN class="caps">UTF</SPAN>-8 presently.</P>


	<P>The speed is pretty good.  Creating new strings, adding string and dup’ing strings end up being generally just as fast as builtin strings.  Substrings and slicing don’t compare, though.  But not much additional memory is used.  One 4-byte index is used for every 16 characters.  So, it’s about 20-25% over the raw string.</P>


	<P>The repository is <A href="../https://code.whytheluckystiff.net/svn/wordy/trunk">here</A>.  I could use some help finding a replacement for <CODE>bitcopy</CODE>, which is like a <CODE>memcpy</CODE> with bit offsets. The one I’m using is fast but buggy.</P>


	<P class="update"><STRONG>Wait, uh:</STRONG> I’m going to hold off an watch what Nikolai is doing <A href="http://git.bitwi.se/?p=unicode.git;a=summary">here</A>.</P></DIV> 
</DIV>
<DIV class="entryFooter"> 
    <NOBR>18 Jul 2006</NOBR> at <NOBR>00:15</NOBR>
    <NOSCRIPT></NOSCRIPT>
   | 
    28 comments
</DIV>
</DIV>
<DIV id="comments">


<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>Thijs</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>18 Jul 2006</NOBR> at <NOBR>04:22</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P>There’s allready an initiative to get some unicode support. It seems like they’re trying  to achieve the same goal:</P>


	<P>http://julik.textdriven.com/svn/tools/rails_plugins/unicode_hacks/</P>


	<P>It will be put in core for 1.2:</P>


	<P>http://www.ruby-forum.com/topic/72893#new</P></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>Qerub</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>18 Jul 2006</NOBR> at <NOBR>05:05</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><PRE><CODE>
class String
  def +@() Wordy.new(self) end
end

(+"Smörgåsbord").class # =&gt; Wordy
</CODE>
</PRE></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>nornagon</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>18 Jul 2006</NOBR> at <NOBR>06:05</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P>+1, Qerub. Make this hack as simple to use as possible.</P></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>Julik</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>18 Jul 2006</NOBR> at <NOBR>06:50</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P>So basically you made the 15th Unicode string implementation for Ruby. Without normalisation.</P>


	<P>Can’t name it the time well spent, although the effort is noble.</P>


	<P>Check out  ICU4R  for something four times as complete (and about 50 times as large).</P></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>murphy</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>18 Jul 2006</NOBR> at <NOBR>09:33</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P>interesting!</P></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>why</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>18 Jul 2006</NOBR> at <NOBR>09:37</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P><STRONG>Thijs:</STRONG> This one’s in C.</P>


	<P><STRONG>Qerub:</STRONG> Cool!</P>


	<P><STRONG>Julik:</STRONG> This one’s in C.</P></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>murphy</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>18 Jul 2006</NOBR> at <NOBR>09:55</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P>@why: just a thought. I don’t know much about Unicode implementations.</P>


	<P>If you store the index of the char, rather the it’s length, so that index_s in your above example would be:</P>


	<PRE><CODE>[0, 3, 6, 9, 12, 15, 18, 19, 22, 25, 28, 31, 34, 37, 40]</CODE></PRE>


you can
	<UL>
	<LI>simply calculate length by difference</LI>
		<LI>accessing a char anywhere in the string in O(1)</LI>
		<LI>calculate the byte length of any slice in O(1)</LI>
	</UL>


you must
	<UL>
	<LI>recalculate all indexes when something is inserted</LI>
		<LI>concatenation is also more work</LI>
	</UL>


	<P>but it seems more natural to me. the old linked-list-versus-pointer-array problem.</P></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>why</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>18 Jul 2006</NOBR> at <NOBR>10:14</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P>If you do that, though, then you have to store an <CODE>unsigned long</CODE> for every character.  So you might as well just store a pointer to that character.  I went that route at first, just while playing around, but you don’t really loose that much speed with the offsets.</P>


	<P>On big documents sure, but <CODE>wordy_charpos</CODE> also will compute the offset from the end of the list (or a supplied pointer from a previous search,) whichever is most efficient.</P></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>nweibull</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>18 Jul 2006</NOBR> at <NOBR>10:19</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P>“the old linked-list-versus-pointer-array problem”</P>


	<P>which is usually solved by using some form of tree structure with O(lg n) access times instead.</P>


	<P>Either way, storing indexes is hardly the way to deal with  UTF -8.  Then you might as well use  ICU4R  as turning the string into  UTF -16 should be about as time-consumirg in the first run as this index calculating stuff.</P>


	<P>Anyway, I have a library that’s still under heavy development, but it does do all the mostly used stuff.</P>


	<P>You can check it out at my <A href="http://git.bitwi.se/?p=unicode.git;a=tree">git repository</A>.</P>


	<P>What it does is mixes in methods into the String class, using the u”...” notation _why previously demonstrated.  I guess using +”...” is better, though, as it will work in all cases.</P>


	<P>Anyway, it doesn’t do anything fancy.  It just treats the contents of the String (or RString) as a sequence of bytes.  The only thing I might like to add to RString would be a char_len field (or something similarly named) that keeps track of the number of “characters” in the string, not the number of bytes.  This would help with index checking.</P>


	<P>What’s important, however, is that it works.</P>


	<P>To give credit where credit is due: The actual utf-8 handling is heavily based on/borrowed/stolen code from the glib library.</P>


	<P>The library is currently based on Unicode 4.1, but as Unicode 5.0 got out of beta today (!), there will hopefully be support for 5.0 soon.</P></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>why</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>18 Jul 2006</NOBR> at <NOBR>10:36</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P>For anyone who wants to try nweibull’s lib:</P>


<PRE> cg-clone http://git.bitwi.se/unicode.git/
</PRE>

	<P>Still, you’re using the same general idea with the decomposition table.  Hey, this is great stuff!  I was really hoping someone would pop up with something better.  Is there something special I need to do to get this to compile?</P></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>nweibull</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>18 Jul 2006</NOBR> at <NOBR>10:53</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P>The decomposition stuff is only used for normalization – or am I missing something?</P>


	<P>To compile:</P>


	<PRE><CODE>$ ruby extconf.rb
$ make</CODE></PRE>


	<P>Hopefully that’ll work.  You’ll probably need gcc , or at least a compiler that understands  C99 .  If someone wants to backport it to  C89  that’s fine, but I really don’t think C is fun enough to limit myself to the dated rules of  C89 .</P>


	<P>Also, this is taken from an earlier project where the code was used for a text editor I was writing and since I’ve been in programming mode, not packacking &amp; maintenance mode the previous week, the library will install as ‘ned/unicode’.  I’m thinking that simply calling the library ‘utf8’ or ‘now/utf8’ (I’m trying to put all my libraries in the ‘now’ “namespace”) will do fine.</P>


	<P>Running rake will run the rspec-based tests (which are far too few in number).</P>


	<P>Anyway, my long-term goal is to make the string processing as generic as possible so that other encodings can be supported (like Oniguruma does today).  That way, most of the code that will be needed for Rite will already exist by the time that stuff is going to be implemented.</P>


	<P>However, more hints on exactly how Matz wants Strings to work in Ruby 2.0 will be necessary.</P></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>Julik</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>18 Jul 2006</NOBR> at <NOBR>10:57</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P>Ok, so now we have about 4-5 implementations in C/Ruby for doing the same thing. Cool.</P></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>Julik</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>18 Jul 2006</NOBR> at <NOBR>11:00</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P>Just to count – Unicode gem, utf8_proc, the two implementations mentioned in this entry and  ICU4R .</P>


	<P>I’m all for diversity but maybe you guys can join forces?  ICU4R  is in C, _why. And it will be most likely times faster than other stuff people come up with in a hackish way.</P></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>why</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>18 Jul 2006</NOBR> at <NOBR>11:27</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P><STRONG>nweibull:</STRONG> Okay, I’m getting an error on FreeBSD, some conflict with the <CODE>index</CODE> method definition in <CODE>/usr/include/strings.h</CODE>.  I’ll play with it.</P></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>asdf</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>18 Jul 2006</NOBR> at <NOBR>11:33</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><PRE>Looking forward
to the day
we will have
as many implementations
as codepoints.
</PRE></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>nweibull</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>18 Jul 2006</NOBR> at <NOBR>12:02</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P><STRONG>Julik</STRONG>: Here’s a breakdown of the libraries that exist so far:</P>


	<P>Yoshida Masato’s Unicode library only does normalization and case conversion.</P>


	<P>UTF8Proc seems to do even less, by only doing normalization.  I may be looking at an old (0.2) version, though.</P>


	<P>The unicode_hacks plugin for RoR does quite a lot, but in a very inefficient way, as it is written in Ruby (a lot of allocation work is done, which can be avoided in C).</P>


	<P> ICU4R  uses  ICU , which is a fanstastic Unicode library (probably the most complete there is).  The problem is,  ICU  uses  UTF -16 internally, and this is definitely not always what you want.</P>


	<P>I can’t say much about _why’s library, but it looks like it can do some nice stuff, even though it’s immature.</P>


	<P>About my own library: It layers “flawlessly” over Ruby’s own String class, so there’s no conversion going on, there’s no extra allocation necessary, there’s no speed decrease (or increase for that matter) of operations that don’t deal with  UTF -8, it does do all the stuff you would like to do.  It isn’t a hack.  It is, however, a work in progress, and some methods are still not implemented.  Also, error checking is missing in many places, so feeding it illegal  UTF -8-sequences may blow your Ruby session.</P>


	<P><STRONG>why</STRONG>: Ouch, typical – I use <CODE>index</CODE> as a variable name in quite a few places, and it seems like your compiler has issues.  Using <CODE>index</CODE> as the name of a local variable should be acceptable, but I’ll try to come up with better names for my variables.</P>


	<P><STRONG>asdf</STRONG>: Seeing as how the number of possible code points are limited in Unicode, that day may yet come.</P></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>why</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>18 Jul 2006</NOBR> at <NOBR>13:57</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P><STRONG>nweibull:</STRONG> Okay, after renaming index and strnstr, I’ve got it compiled.  The specs don’t run for me, since there’s no <CODE>Kernel#u</CODE>.</P>


	<P>It looks like <CODE>Kernel#u</CODE> should be:</P>


<PRE> def u(str); str.extend UTF end
</PRE>

	<P>I really like what you’ve got here.  I want to play with it.</P></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>sporkmonger</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>18 Jul 2006</NOBR> at <NOBR>14:28</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P>I don’t suppose anyone has an implementation of stringprep/nameprep in Ruby floating around?</P></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>nweibull</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>18 Jul 2006</NOBR> at <NOBR>16:36</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P><STRONG>why</STRONG>: That’s weird.  Are you sure unicode.rb is getting loaded?  It, in turn, requires unicode.so and sets up the bindings.  <CODE>Kernel#u</CODE> should be <CODE>def u(str); str.extend(UTFMethods); end</CODE> and it is defined in unicode.rb.  I wonder why this isn’t working for you…</P>


	<P>Perhaps running the specifications without having the library installed works?  Although, the <CODE>$LOAD_PATH.unshift '..'</CODE> should make sure that everything works correctly inside the specifications.</P>


	<P>Anyway, I’m allocating tomorrow to clean up the file structure and make sure that compilation, testing, and installation work better than they do now.</P></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>FlashHater</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>18 Jul 2006</NOBR> at <NOBR>18:18</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P><STRONG>Julik:</STRONG> _why is writing it, so it’ll be 10x greater than all the other libraries!!! :D  </P></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>murphy</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>18 Jul 2006</NOBR> at <NOBR>18:49</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><BLOCKQUOTE>
		<P>If you do that, though, then you have to store an unsigned long for every character.</P>
	</BLOCKQUOTE>


	<P>oh yes, that’s true. didn’t thought about that.</P>


	<P>I’m glad you are addressing two of the most popular con’s about Ruby: bad Unicode support and lack of speed.</P></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>hgs</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>19 Jul 2006</NOBR> at <NOBR>04:11</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P>I’ve been reading <A href="http://www.amazon.co.uk/gp/product/0321150783/026-7938299-3302867?v=glance&n=266239">Lean Software Development: An Agile Toolkit</A>
and this advocates deferring decisions where practical, because things change.  It also advocates havine multiple implementations of something, because when the groups get together you can breed something wonderful from the diverse gene pool.
This does require the groups to talk, though.</P></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>Julik</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>21 Jul 2006</NOBR> at <NOBR>08:50</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P>At the moment we want to be a) interoperable with others b) without nasty subclassing (what you have) c) without compiling stuff.</P>


	<P>I think we nailed the compromises pretty well. When your extension is ready we will try to implement a handler for it.</P>


	<P>As for the inefficiency – well, do better without C. Manfred will be eager to hear your suggestions. And do better when some strings you process might not be Unicode strings either.</P></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>Julik</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>21 Jul 2006</NOBR> at <NOBR>08:55</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P>In all fairness – if you want to flex your C muscle just pick up  ICU4R  and finish it.</P></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>Julik</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>21 Jul 2006</NOBR> at <NOBR>09:07</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P>Besides,</P>


	<P>git clone http://git.bitwi.se/unicode.git/
Cannot get remote repository information.
Perhaps git-update-server-info needs to be run there?</P>


	<P>git clone git://git.bitwi.se/unicode.git/
fatal: unable to connect a socket (Connection refused)
fetch-pack from ‘git://git.bitwi.se/unicode.git/’ failed.</P></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>nweibull</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>23 Jul 2006</NOBR> at <NOBR>11:06</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P><STRONG>Julik</STRONG>: If you’re addressing me above: a) remains true, b) isn’t true, c) eh?</P>


	<P>There’s no subclassing going on here.  All that happens is that the string is extended with a module.</P>


	<P>Again, I am not here to replace someone else’s solution or claim that my solution is the last word in character encoding handling.</P>


	<P>I’ve already stated why  ICU4R  isn’t a solution for me.  I don’t want my strings decoded, encoded, and re-encoded.  I want them to remain a sequence of bytes.</P>


	<P>Strange that cg-clone worked.  I forgot to chmod post-update.</P>


	<P>Anyway, there’s a <A href="http://git.bitwi.se/?p=ruby-character-encodings.git;a=summary">new repository</A>, which you can clone:</P>


	<PRE><CODE>git clone http://git.bitwi.se/ruby-character-encodings.git</CODE></PRE></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>Julik</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>24 Jul 2006</NOBR> at <NOBR>13:56</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P>Nikolai, what I meant by “subclassing” is _why’s method of doing u”bla” (who’s going to do u”bla” on the  CGI  params and the database and the sockets…), I confused somewhat. Especially considering I couldn’t look at your extension because of these bizarro git things I’m barely familiar with.</P>


	<P>The fact that  ICU4R  uses separate strings and regexps is a hindrance. but  ICU  implements alot of very very fancy Unicode mechanics (locale-aware sentence boundaries? word boundaries? locale-independent grapheme clusters?). The problem is that making your own will oblige you to implement all (or some of these) by yourself.  OTOH , ICU4R is abandoned now and you can easily rig it into Ruby’s String (which will make it much more useable).</P>


	<P>We did the mixing in of methods somewhat differently (making a wrapper around Strings with same  API , but preserving the original string). We also do native regexps (with character offsets) and gsub – basically all that String does.</P>


	<P>All I hope for is we can make a handler for our plugin with your extension when it’s ready. And when it builds and runs on  OS X  without diffs, for that matter :-)</P></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>nweibull</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>24 Jul 2006</NOBR> at <NOBR>17:01</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P><STRONG>Julik</STRONG>: Dealing with grapheme clusters and various boundaries is of course awesome, so hopefully I or someone else (<STRONG>hint</STRONG>, <STRONG>hint</STRONG>) will write code for that as well.</P>


	<P>I don’t own a Mac, and I don’t run FreeBSD or Windows, so someone will have to help me with the OS porting.</P>


	<P>Anyway, all I hope now is that I didn’t announce this library too soon.</P>


	<P>Current task is to write up specifications so that we can ensure backwards compatibility while supporting unicode as well.</P></DIV></DIV>
</DIV>


<DIV class="entry">
<FORM name="userComment" method="post" action="/api/comment/inspect/muckingWithUnicodeFor18">
  <DIV class="entryAttrib">
     <DIV class="entryAuthor"><INPUT name="sayor" type="textbox" size="15" maxlength="50"></DIV>
     <DIV id="liveTime" class="entryTime"><NOBR>11 Jul 2010</NOBR> at <NOBR>21:30</NOBR></DIV>
  </DIV>
  <DIV class="entryContentOuter"><DIV class="entryContent">
     <INPUT type="hidden" name="timestamp" value="yopYLare1A">
     <TEXTAREA name="consay" rows="6" cols="50"></TEXTAREA>
     <P><INPUT type="button" name="pleasePreview" value="preview" onclick="liveTextilePreview(document.forms[&#39;userComment&#39;].elements[&#39;consay&#39;], &#39;textilePreview&#39;, &#39;/api/preview&#39;)">
        <INPUT type="submit" name="submit" value="&gt;&gt;">
        <SMALL>* do <A href="../javascript:quickRedReference();">fancy stuff</A> in your comment.</SMALL>
     </P>
     <DIV id="textileWrap"><H4>PREVIEW PANE</H4>
     <DIV id="textilePreview"></DIV>
     </DIV>
     </DIV>
  </DIV></FORM></DIV>
  



        </DIV> 

</DIV>



</DIV>





</BODY></HTML>