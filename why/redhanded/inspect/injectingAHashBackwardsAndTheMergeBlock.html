<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "DTD/xhtml1-transitional.dtd">
<!-- saved from url=(0114)redhanded.hobix.com/inspect/injectingAHashBackwardsAndTheMergeBlock.html -->
<HTML xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><HEAD><META http-equiv="Content-Type" content="text/html; charset=UTF-8">
<!--<BASE href="http://redhanded.hobix.com.wstub.archive.org/inspect/injectingAHashBackwardsAndTheMergeBlock.html">--><BASE href=".">


<TITLE>RedHanded » Injecting a Hash Backwards and the Merge Block</TITLE>
<LINK rel="shortcut icon" href="../favicon.ico" type="image/vnd.microsoft.icon" />
<LINK rel="icon" href="../favicon.ico" type="image/vnd.microsoft.icon" />
<META http-equiv="Pragma" content="no-cache">
<META http-equiv="Expires" content="-1">




<STYLE type="text/css">
 @import "../site.css"; 
</STYLE>
</HEAD><BODY>

<DIV id="page">

<DIV id="hoodwinkd">
  <A href="http://hoodwinkd.hobix.com/"><SPAN>hoodwink.d enhanced</SPAN></A>

</DIV>
<DIV id="buttons">
<DL class="tab">
  <DT><A title="Syndicate this Site" href="index.xml">RSS</A></DT>
  <DD><A title="Syndicate this Site" href="index.xml">2.0</A></DD>
</DL>
<DL class="tab xhtml">
  <DT><A title="Validate this Site" href="http://validator.w3.org/check?uri=http://redhanded.hobix.com/">XHTML</A></DT>
  <DD><A title="Validate this Site" href="http://validator.w3.org/check?uri=http://redhanded.hobix.com/">1.0</A></DD>
</DL>
</DIV>
<H1 class="title"><A href="../"><IMG src="../images/redhanded.gif" alt="RedHanded"></A></H1>
<DIV id="banner">
  <DIV class="tagline">sneaking Ruby through the system</DIV>
  <DIV class="nav"><A href="../5.gets/">5.gets</A> | <A href="../bits/">bits</A> | 
    <A href="../inspect/">inspect</A> | <A href="../cult/">the cult</A> | <A href="../-h/">-h</A></DIV>
</DIV>


<DIV id="content">
<DIV id="sidebar">
<P>New to RedHanded? <A href="../-h/pardonAndWelcome.html">About our sections.</A></P>

<DIV class="sidebarBox">
<H2 class="sidebarTitle">Archive</H2>
<UL>

    <LI><A href="../2004/12/">December 2004</A></LI>

    <LI><A href="../2005/01/">January 2005</A></LI>

    <LI><A href="../2005/02/">February 2005</A></LI>

    <LI><A href="../2005/03/">March 2005</A></LI>

    <LI><A href="../2005/04/">April 2005</A></LI>

    <LI><A href="../2005/05/">May 2005</A></LI>

    <LI><A href="../2005/06/">June 2005</A></LI>

    <LI><A href="../2005/07/">July 2005</A></LI>

    <LI><A href="../2005/08/">August 2005</A></LI>

    <LI><A href="../2005/09/">September 2005</A></LI>

    <LI><A href="../2005/10/">October 2005</A></LI>

    <LI><A href="../2005/11/">November 2005</A></LI>

    <LI><A href="../2005/12/">December 2005</A></LI>

    <LI><A href="../2006/01/">January 2006</A></LI>

    <LI><A href="../2006/02/">February 2006</A></LI>

    <LI><A href="../2006/03/">March 2006</A></LI>

    <LI><A href="../2006/04/">April 2006</A></LI>

    <LI><A href="../2006/05/">May 2006</A></LI>

    <LI><A href="../2006/06/">June 2006</A></LI>

    <LI><A href="../2006/07/">July 2006</A></LI>

    <LI><A href="../2006/08/">August 2006</A></LI>

    <LI><A href="../2006/09/">September 2006</A></LI>

    <LI><A href="../2006/10/">October 2006</A></LI>

    <LI><A href="../2006/11/">November 2006</A></LI>

    <LI><A href="../2006/12/">December 2006</A></LI>

    <LI><A href="../2007/01/">January 2007</A></LI>

    <LI><A href="../2007/02/">February 2007</A></LI>

    <LI><A href="../2007/03/">March 2007</A></LI>

    <LI><A href="../2007/04/">April 2007</A></LI>

    <LI><A href="../2007/05/">May 2007</A></LI>

</UL>
</DIV>

<P><A href="http://www.pragmaticprogrammer.com/titles/ruby/index.html"><IMG src="../images/prag-ruby-book.jpg" alt="PickAxe II"></A><BR>
<A href="http://www.pragmaticprogrammer.com/titles/ruby/index.html">Get your copy of <I>Programming Ruby</I>!</A></P>

 <DIV class="sidebarBox">
        <H2 class="sidebarTitle">Links</H2>
        <A href="http://technorati.com/tags/ruby">@technorati</A><BR>
<A href="http://del.icio.us/tag/ruby">@del.icio.us</A><BR>
<A href="http://www.flickr.com/photos/tags/ruby">@flickr</A><BR>
<A href="http://www.artima.com/articles/index.jsp?topic=ruby">@artima</A><BR>
<A href="http://blog.caboo.se/">@caboo</A><BR>
<A href="http://www.oreillynet.com/ruby">@oreilly</A><BR>
<A href="http://ruby-lang.org/">ruby</A><BR>
<A href="http://ruby-doc.org/">-&gt; docs</A><BR>
<A href="http://rubyforge.org/">-&gt; wares</A><BR>
<A href="http://rubygarden.org/ruby/">-&gt; wiki</A><BR>
<A href="http://www.sitepoint.com/forums/forumdisplay.php?f=227">-&gt; forum</A><BR>
<A href="http://www.rubyquiz.com/">-&gt; quizzes</A><BR>
<A href="http://planetruby.0x42.net/">-&gt; planet</A><BR>
<A href="http://meme.b9.com/cdates.html?channel=ruby-lang">-&gt; irc</A><BR>
<A href="http://www.rubyweeklynews.org/">rubyweeklynews</A><BR>
<A href="http://weblog.rubyonrails.com/">rails</A><BR>
<A href="http://wiki.rubyonrails.org/">-&gt; wiki</A><BR>
<A href="http://www.planetrubyonrails.org/">-&gt; planet</A><BR>
<A href="http://thesaq.com/rubyonrails/">-&gt; irc</A><BR>
<A href="http://anarchaia.org/">%anarchaia</A><BR>
<A href="http://project.ioni.st/">%projectionist</A><BR>
<A href="http://pugs.blogs.com/">~audreyt</A><BR>
<A href="http://dablog.rubypal.com/">~black</A><BR>
<A href="http://www.jamesbritt.com/">~britt</A><BR>
<A href="http://www.jamisbuck.org/jamis/">~buck</A><BR>
<A href="http://tomcopeland.blogs.com/juniordeveloper/">~copeland</A><BR>
<A href="http://eigenclass.org/">~fernandez</A><BR>
<A href="http://www.chadfowler.com/">~fowler</A><BR>
<A href="http://www.loudthinking.com/">~hansson</A><BR>
<A href="http://blog.segment7.net/">~hodel</A><BR>
<A href="http://slash7.com/">~hoy/7</A><BR>
<A href="http://fhwang.net/">~hwang</A><BR>
<A href="http://blog.leetsoft.com/">~luetke</A><BR>
<A href="http://www.worldlingo.com/wl/translate?wl_lp=JA-en&wl_glossary=gl1&wl_fl=3&wl_rurl=http%3A%2F%2Fwww.rubyist.net%2F%7Ematz%2F&wl_url=http%3A%2F%2Fwww.rubyist.net%2F%7Ematz%2F&wl_g_table=-3">~matz</A><BR>
<A href="http://moonbase.rydia.net/">~mental</A><BR>
<A href="http://techno-weenie.net/">~olson</A><BR>
<A href="http://pragprog.com/pragdave">~pragdave</A><BR>
<A href="http://www.livejournal.com/users/premshree/">~premshree</A><BR>
<A href="http://kronavita.de/chris/blog/">~neukirchen</A><BR>
<A href="http://www.robbyonrails.com/">~robby</A><BR>
<A href="http://www.rousette.org.uk/">~rousette</A><BR>
<A href="http://nubyonrails.com/">~topfunky</A><BR>
<A href="http://www.jvoorhis.com/">~voorhis</A><BR>
<A href="http://onestepback.org/">~weirich</A><BR>
<A href="http://blog.zenspider.com/">~zenspider</A><BR>
        </DIV> 
 <DIV class="sidebarBox">
        <H2 class="sidebarTitle">Syndicate</H2>
        <UL>
            <LI><A href="../index.xml">RSS 2.0</A></LI>
        </UL>
        </DIV> 
 <DIV class="sidebarBox">
        <P>Built upon <A href="http://hobix.com/">Hobix</A></P>
        </DIV> 
<IMG src="../images/redhanded-duck.gif" alt="Type the Duck">
<DIV class="email">Got a story for us? <A href="../mailto:redhanded@hobix.com">E-mail it!</A></DIV>
<DIV class="technorati"><P><A href="http://www.technorati.com/profile/whytheluckystiff">Technorati Profile</A>
<A href="http://www.technorati.com/cosmos/search.html?url=http%3A%2F%2Fredhanded.hobix.com"><BR>
<IMG src="../images/bubble_icon.gif" height="20" width="24" alt="Get Conversations about RedHanded &raquo; sneaking Ruby through the system"></A>
</P>
</DIV>

</DIV>


 <DIV id="blog">
        
<DIV class="entry">
    <H2 class="entryTitle">Injecting a Hash Backwards and the Merge Block
  <SPAN class="entryPermalink"><A href="../inspect/injectingAHashBackwardsAndTheMergeBlock.html" title="Permanent link to &ldquo;Injecting a Hash Backwards and the Merge Block&rdquo;">#</A></SPAN>
</H2>

<DIV class="entrySection">by <A href="http://whytheluckystiff.net/" title="Visit why&#39;s homepage">why</A> 
  in <A href="../inspect" title="List of entries in the &ldquo;inspect&rdquo; category">inspect</A>
</DIV>

     <DIV class="entryContent"><P>Here’s a fun snippet cooked up for the Camping 1.3 release due later today, laid out a bit nicer so you can play with it on your own.</P>


	<P>Goal is: to parse a query string in as few bytes as possible.  And to allow the Hash-like syntax from <SPAN class="caps">PHP</SPAN> and Rails.</P>


<PRE> def qs_parse(qs)
   qs.split(/[&amp;;]/n).
      inject({}) { |h,p| 
        k, v = p.split('=',2)
        h.merge(
          k.split(/[\]\[]+/).reverse.
            inject(v) { |x,i| {i=&gt;x} }
        ){|_,o,n|o.merge(n)}
      }
 end
</PRE>

	<P>Believe me, there’s a real zen in the inner-inject/merge-block routine.  Wield it like so:</P>


<PRE> &gt;&gt; qs_parse("name=Philarp+Tremain&amp;hair=sandy+blonde")
 =&gt; {"name"=&gt;"Philarp+Tremain", "hair"=&gt;"sandy+blonde"}
 &gt;&gt; qs_parse("post[id]=4&amp;post[nick]=_why&amp;post[message]=GROSS!&amp;a=1")
 =&gt; {"a"=&gt;"1", "post"=&gt;{"message"=&gt;"GROSS!", "nick"=&gt;"_why", "id"=&gt;"4"}}
</PRE>

	<P>Obviously, in the final version, stuff gets unescaped and all that.  This exercise only focuses on parsing the structure.  It would be nice for the merge-block to be tail recursive.  It only goes one level presently.</P>


	<P class="update"><STRONG>Update:</STRONG> Here’s a right-good one which recurses to any depth and builds an array from duplicate entries as Dan pointed out.</P>


<PRE> def qs_parse(qs)
   m = proc {|_,o,n|o.merge(n,&amp;m)rescue(o.to_a&lt;&lt;n)}
   qs.split(/[&amp;;]/n).
      inject({}) { |h,p| 
        k, v = p.split('=',2)
        h.merge(
          k.split(/[\]\[]+/).reverse.
            inject(v) { |x,i| {i=&gt;x} },&amp;m)
      }
 end
</PRE></DIV> 
</DIV>
<DIV class="entryFooter"> 
    <NOBR>25 Jan 2006</NOBR> at <NOBR>12:40</NOBR>
    <NOSCRIPT></NOSCRIPT>
   | 
    31 comments
</DIV>
</DIV>
<DIV id="comments">


<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>Ezra Zygmuntowicz</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>25 Jan 2006</NOBR> at <NOBR>13:39</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P>oooh! Pretty!</P></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>yerejm</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>25 Jan 2006</NOBR> at <NOBR>13:46</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P>Hmm… 
&gt; _.class
=&gt; NilClass</P></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>fansipans</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>25 Jan 2006</NOBR> at <NOBR>14:03</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P>_ is just a variable name, best used as a place holder in tiny code. it is used above elegantly with the block-enabled Hash.merge to handle cases where you have two hashes  with the same name, but with their own values. {|key,oldval,newval| oldval.merge(newval)} blends the two hashes from the query string</P>


	<P>so foo[bar]=baz and foo[qux]=bop ends up being the full foo={bar=&gt;baz, qux=&gt;bop}</P>


	<P>man yeah i’d love to see some arbitrarily deep hash support (_why, you should have posted this at 4:20 hehe)</P>


	<P>mmmmmmmmmm</P></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>Harold</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>25 Jan 2006</NOBR> at <NOBR>15:07</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P>The ‘n’ option on the regex is what? Multibyte aware or something?</P></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>why</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>25 Jan 2006</NOBR> at <NOBR>15:17</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P><STRONG>fansipans:</STRONG> I’m with you.  This post was underorchestrated.</P>


	<P><STRONG>Harold:</STRONG> Yes, another byte gone.   GLAD .</P></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>lee b.</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>25 Jan 2006</NOBR> at <NOBR>15:44</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P>you can just have</P>


	<PRE><CODE>k,v = p.split '='</CODE></PRE>


	<P>and the other split elements will be discarded.</P>


	<P>also, unless you want to match</P>


	<PRE><CODE>post[[id]]=4</CODE></PRE>


	<P>or something similarly perverse, the inner split’s regex can be</P>


	<P>/[\]\[]/</P>


	<P>without the plus sign (or /[][]/ if you don’t mind warnings).</P>


	<P>lee</P></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>?????</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>25 Jan 2006</NOBR> at <NOBR>16:13</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P>Why do you write the code so tersly?  Is it to keep the file size down?  It makes it really hard for beginners to follow what is going on.  I know I am asking a lot, but could you post an expanded version (full variable names, generous white space) for these short expositions?  I think I could learn more that way.</P></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>Daniel Berger</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>25 Jan 2006</NOBR> at <NOBR>16:23</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P>Hmm, I thought the  URI  class had some helpers for this already, but I don’t see anything.</P>


	<P>Perhaps  URI  could use some polish?</P>


<PRE># Ideal syntax (?)
uri = URI.parse(qs)
uri.query.name # Philarp Tremain
uri.query.hair # Sandy Blonde
</PRE>
I guess we’ll need a  URI ::Query class first, eh?</DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>mindtriggerz</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>25 Jan 2006</NOBR> at <NOBR>17:13</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P><STRONG>????:</STRONG> There’s an expanded version in camping svn.</P></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>why</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>25 Jan 2006</NOBR> at <NOBR>17:56</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P>Golfing code is meant to challenge.  It’s like Sudoku or Rubik, but the kick of it is that you’re actually left with something handy.</P>


	<P><STRONG>Daniel:</STRONG> There’s a nice thought.  I’m sure it could wipe out some code in WEBrick, too.</P></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>Dan</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>25 Jan 2006</NOBR> at <NOBR>19:55</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P>It barfs on multiple values for the same name, which is legal  HTML :</P>


	<P>qs_parse(“foo=4&amp;foo=6”)</P></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>why</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>26 Jan 2006</NOBR> at <NOBR>00:28</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P>Okay, updated to be recursive and handle the bug Dan found.</P></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>yerejm</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>26 Jan 2006</NOBR> at <NOBR>02:36</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P><STRONG>fansipans</STRONG>: Turns out _ is something irb adds to confuse me…</P></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>Dan</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>26 Jan 2006</NOBR> at <NOBR>07:22</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P>Nice fix! On a separate note, I’m a Java developer (boo, hiss) who’s really excited about Ruby. But one of the things I don’t like is when it becomes too ‘Perl-like’ (read: impenetrable, brevity over clarity), and I’m wondering if you see this code snippet as just an exercise, or whether you would write code this way on a large project meant to be shared with other developers. It’s probably just my inexperience with Ruby talking, but if I had to debug this or add a feature to it, I would be well screwed. So, is this meant to be poetry? As that, it’s wonderful.</P></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>Avdi</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>26 Jan 2006</NOBR> at <NOBR>11:05</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P>I admit it took me awhile to parse through that code mentally.  The irony, though, is that despite it’s almost Perlish density, the functional programming crowd would probably consider it not merely elegant, but the “right” way to do it.  And not without reason, either.  For all it’s complexity, it’s not relying on any special rules or wierd syntactic truicks like Perl might.  Although it would probably be a little prettier in Haskell, and the ‘inject’s would be called ‘fold’.</P>


	<P>This isn’t really an opionion one way or another; just an observation that the Functional and Scripting worlds are getting closer and closer together.</P></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>THBMan</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>26 Jan 2006</NOBR> at <NOBR>12:27</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P>Ok, that took me a few minutes and my copy of the pickaxe, but I got it. Very nice. The only thing I don’t get is why there’s a rescue in the m Proc. I thought if merge found two elements the same it would overwrite the old with the new, not raise.</P></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>cilibrar</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>26 Jan 2006</NOBR> at <NOBR>19:55</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P>Why’s page has been squarely aimed at Ruby experts for all of this year and most of last in my opinion.  I had to read the column for over a year (and practice Ruby independently) before I was ready to seriously start understanding the examples like Dwemthy.  The fact of the matter is, anybody who doesn’t like Ruby won’t learn it, and if you don’t learn it you won’t have to debug it because you won’t be doing it.  simple!</P></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>fansipans</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>26 Jan 2006</NOBR> at <NOBR>20:11</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P><B>cilibrar</B>: _why’s hijinx definitely have a very challenging spirit, i know it’s encouraged me to beef up and understand more and more… co-workers at a big meeting yesterday got a big kick  (and nodded in agreement) with my use of the words “kung-fu” and “zen” in reference to proper design ;)</P></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>yerejm</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>27 Jan 2006</NOBR> at <NOBR>02:57</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P><STRONG>THBMan</STRONG></P>


	<P>foo=1&amp;bar=2 : no duplicate keys, proc no fire, merges with no issue</P>


	<P>foo[bar]=1&amp;foo[baz]=2 : duplicate outer keys, merge asks proc to fire, bar and baz are inner unique keys (if they weren’t, recursive proc call), no rescue, merges like above</P>


	<P>foo=1&amp;foo=2 : duplicate key, proc fires, 1 and 2 are not hashes, rescue fires, foo key points to array in the “merged” hash and values accumulate</P>


	<P>merge by default overwrites. The proc given  to it doesn’t do that.</P>


	<P>Or at least that’s my understanding of the _whyjinx.</P></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>Juho Snellman</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>27 Jan 2006</NOBR> at <NOBR>18:26</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P>That seems pretty complicated if the goal really is to accomplish the task in as few bytes as possible.</P>


	<P>The following function should fulfill the informal spec about as well as the updated version above, and has only 122 non-whitespace characters compared to 177 in the original.</P>


<PRE><CODE>
def qs_parse(qs)
  h = s = {}
  $3?(s[$1], s = s[$1] ? s[$1].to_a &lt;&lt; $3 : $3, h):s = s[$1] ||= {} while qs.gsub!(/^\[?(\w+)\]?(=([^&amp;;]*).?)?/, '')
  h
end
</CODE>
</PRE>

	<P>(Sorry if I missed any obvious golf tricks; this is my first Ruby program).</P></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>me</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>27 Jan 2006</NOBR> at <NOBR>19:43</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P>Juho: What is the “informal spec” that you are referring to?  There are query strings for which your function doesn’t appear to work properly (as well as other cases for which the updated version above still doesn’t seem to work properly) but I am not clear whether such strings are supposed to permitted, so I’d like to see the spec.</P></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>Juho Snellman</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>27 Jan 2006</NOBR> at <NOBR>22:34</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P>Sorry, by “informal spec” I pretty much meant this blog post and the comments, not an actual specification.</P>


	<P>The examples specify the intended basic behaviour. The comments suggest that strings like <CODE>foo[bar][baz]=1</CODE> should be handled properly. And the lack of any error detection (e.g. checking that the brackets are balanced) in the original means that such things matter less than making the code short ;-)</P></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>why</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>28 Jan 2006</NOBR> at <NOBR>00:07</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P>Juho, you wild man, well played.  There’s no rules here, just unfenced sporting arena with starving, sickly grass.  I’m with you on the error detection, let’s just parse it into something.</P></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>why</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>28 Jan 2006</NOBR> at <NOBR>00:26</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P>Oh, Juho.  That qs_parse is going to need a <CODE>dup</CODE> in there, because the string passed in gets destroyed by the <CODE>gsub!</CODE>.</P>


	<P>Also, mine does parse <CODE>camp[]=Dooley&amp;camp[]=Rheinhart</CODE> into <CODE>{"camp" =&gt; ["Dooley", "Rheinhart"]}</CODE>, which does right with the Rails/PHP rules.</P></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>me</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>28 Jan 2006</NOBR> at <NOBR>00:32</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P>Juho: Thanks for the clarification.  What I was wondering about wasn’t such errors, but whether strings like foo=1&amp;foo[bar]=2&amp;foo[baz]=3 should be handled.  I would expect that to return something like {“foo”=&gt;[“1”, {“bar”=&gt;“2”}, {“baz”=&gt;“3”}]} as the original does but yours raises an error. However, the original doesn’t correctly handle similar strings such as foo[bar]=2&amp;foo[baz]=3&amp;foo=1, i.e., the same string but with the parameters simply in a different order.  I had modified the original so I think it handles such cases like the above, but was wondering how they should be treated.</P></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>me</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>28 Jan 2006</NOBR> at <NOBR>00:54</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent">By the way, the original parses strings like these:
<PRE> <CODE>
  camp[]=&amp;camp[]=Rheinhart
  camp[]=Dooley&amp;camp[]=
</CODE> </PRE>
into
<PRE> <CODE>
  {"camp"=&gt;["Rheinhart"]}
  {"camp"=&gt;["Dooley", ""]}
</CODE> </PRE>
Again, I’m not sure how they should be handled, but the second parsing seems to make sense (and the same change I mentioned above also addressed situations like the above in a seemingly consistent way).  What’s the desired behavior?</DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>me</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>28 Jan 2006</NOBR> at <NOBR>01:10</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P>Can someone please tell me where I can find “the Rails/PHP rules” for handling these types of query strings?  It sounds like that will answer the questions I had above.  Thanks.</P></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>Premshree</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>28 Jan 2006</NOBR> at <NOBR>13:06</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P>I had a situation where I wanted to read from a text file that had on each line something like “foo:bar”. Obviously, in my Ruby script I want to get a hash representation. Not very elegant, I’d guess, but anyway, this is what I did:</P>


<PRE>hsh = Hash.new
File.open("test.txt").readlines.each { |line|
        hsh = hsh.update(Hash[ *line.split(":").
                map { |ele| ele = ele.match(/(.*)\n/)[1] rescue ele }
        ])
}
</PRE></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>ntk</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>28 Jan 2006</NOBR> at <NOBR>15:00</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P>How about using scan:
hash = {}; qs.scan(/(name|hair)=(.*?)(&amp;|$)/) { hash.update($1 =&gt; $2)}; puts hash.inspect</P></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>why</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>28 Jan 2006</NOBR> at <NOBR>18:24</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P><STRONG>Premshree:</STRONG> That’s very similar to this bit I saw on  IRC  a great while ago.</P>


<PRE> Hash[*IO.read('test.txt').scan(/^(.+?):(.*)/).flatten]
</PRE></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>ntk</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>29 Jan 2006</NOBR> at <NOBR>11:00</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P>For yet another qs.scan solution check out bigbold.com/snippets/user/ntk !</P></DIV></DIV>
</DIV>


  <DIV class="entry">
    <P><SMALL>Comments are closed for this entry.</SMALL></P>
  



        </DIV> 

</DIV>



</DIV>





</DIV></BODY></HTML>