<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "DTD/xhtml1-transitional.dtd">
<!-- saved from url=(0111)redhanded.hobix.com/inspect/oneSmallFlaskOfMetaprogrammingElixir.html -->
<HTML xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><HEAD><META http-equiv="Content-Type" content="text/html; charset=UTF-8">
<!--<BASE href="http://redhanded.hobix.com.wstub.archive.org/inspect/oneSmallFlaskOfMetaprogrammingElixir.html">--><BASE href=".">


<TITLE>RedHanded » One Small Flask of Metaprogramming Elixir</TITLE>
<LINK rel="shortcut icon" href="../favicon.ico" type="image/vnd.microsoft.icon" />
<LINK rel="icon" href="../favicon.ico" type="image/vnd.microsoft.icon" />
<META http-equiv="Pragma" content="no-cache">
<META http-equiv="Expires" content="-1">




<STYLE type="text/css">
 @import "../site.css"; 
</STYLE>
</HEAD><BODY>

<DIV id="page">

<DIV id="hoodwinkd">
  <A href="http://hoodwinkd.hobix.com/"><SPAN>hoodwink.d enhanced</SPAN></A>

</DIV>
<DIV id="buttons">
<DL class="tab">
  <DT><A title="Syndicate this Site" href="index.xml">RSS</A></DT>
  <DD><A title="Syndicate this Site" href="index.xml">2.0</A></DD>
</DL>
<DL class="tab xhtml">
  <DT><A title="Validate this Site" href="http://validator.w3.org/check?uri=http://redhanded.hobix.com/">XHTML</A></DT>
  <DD><A title="Validate this Site" href="http://validator.w3.org/check?uri=http://redhanded.hobix.com/">1.0</A></DD>
</DL>
</DIV>
<H1 class="title"><A href="../"><IMG src="../images/redhanded.gif" alt="RedHanded"></A></H1>
<DIV id="banner">
  <DIV class="tagline">sneaking Ruby through the system</DIV>
  <DIV class="nav"><A href="../5.gets/">5.gets</A> | <A href="../bits/">bits</A> | 
    <A href="../inspect/">inspect</A> | <A href="../cult/">the cult</A> | <A href="../-h/">-h</A></DIV>
</DIV>


<DIV id="content">
<DIV id="sidebar">
<P>New to RedHanded? <A href="../-h/pardonAndWelcome.html">About our sections.</A></P>

<DIV class="sidebarBox">
<H2 class="sidebarTitle">Archive</H2>
<UL>

    <LI><A href="../2004/12/">December 2004</A></LI>

    <LI><A href="../2005/01/">January 2005</A></LI>

    <LI><A href="../2005/02/">February 2005</A></LI>

    <LI><A href="../2005/03/">March 2005</A></LI>

    <LI><A href="../2005/04/">April 2005</A></LI>

    <LI><A href="../2005/05/">May 2005</A></LI>

    <LI><A href="../2005/06/">June 2005</A></LI>

    <LI><A href="../2005/07/">July 2005</A></LI>

    <LI><A href="../2005/08/">August 2005</A></LI>

    <LI><A href="../2005/09/">September 2005</A></LI>

    <LI><A href="../2005/10/">October 2005</A></LI>

    <LI><A href="../2005/11/">November 2005</A></LI>

    <LI><A href="../2005/12/">December 2005</A></LI>

    <LI><A href="../2006/01/">January 2006</A></LI>

    <LI><A href="../2006/02/">February 2006</A></LI>

    <LI><A href="../2006/03/">March 2006</A></LI>

    <LI><A href="../2006/04/">April 2006</A></LI>

    <LI><A href="../2006/05/">May 2006</A></LI>

    <LI><A href="../2006/06/">June 2006</A></LI>

    <LI><A href="../2006/07/">July 2006</A></LI>

    <LI><A href="../2006/08/">August 2006</A></LI>

    <LI><A href="../2006/09/">September 2006</A></LI>

    <LI><A href="../2006/10/">October 2006</A></LI>

    <LI><A href="../2006/11/">November 2006</A></LI>

    <LI><A href="../2006/12/">December 2006</A></LI>

    <LI><A href="../2007/01/">January 2007</A></LI>

    <LI><A href="../2007/02/">February 2007</A></LI>

    <LI><A href="../2007/03/">March 2007</A></LI>

    <LI><A href="../2007/04/">April 2007</A></LI>

    <LI><A href="../2007/05/">May 2007</A></LI>

</UL>
</DIV>

<P><A href="http://www.pragmaticprogrammer.com/titles/ruby/index.html"><IMG src="../images/prag-ruby-book.jpg" alt="PickAxe II"></A><BR>
<A href="http://www.pragmaticprogrammer.com/titles/ruby/index.html">Get your copy of <I>Programming Ruby</I>!</A></P>

 <DIV class="sidebarBox">
        <H2 class="sidebarTitle">Links</H2>
        <A href="http://technorati.com/tags/ruby">@technorati</A><BR>
<A href="http://del.icio.us/tag/ruby">@del.icio.us</A><BR>
<A href="http://www.flickr.com/photos/tags/ruby">@flickr</A><BR>
<A href="http://www.artima.com/articles/index.jsp?topic=ruby">@artima</A><BR>
<A href="http://blog.caboo.se/">@caboo</A><BR>
<A href="http://www.oreillynet.com/ruby">@oreilly</A><BR>
<A href="http://ruby-lang.org/">ruby</A><BR>
<A href="http://ruby-doc.org/">-&gt; docs</A><BR>
<A href="http://rubyforge.org/">-&gt; wares</A><BR>
<A href="http://rubygarden.org/ruby/">-&gt; wiki</A><BR>
<A href="http://www.sitepoint.com/forums/forumdisplay.php?f=227">-&gt; forum</A><BR>
<A href="http://www.rubyquiz.com/">-&gt; quizzes</A><BR>
<A href="http://planetruby.0x42.net/">-&gt; planet</A><BR>
<A href="http://meme.b9.com/cdates.html?channel=ruby-lang">-&gt; irc</A><BR>
<A href="http://www.rubyweeklynews.org/">rubyweeklynews</A><BR>
<A href="http://weblog.rubyonrails.com/">rails</A><BR>
<A href="http://wiki.rubyonrails.org/">-&gt; wiki</A><BR>
<A href="http://www.planetrubyonrails.org/">-&gt; planet</A><BR>
<A href="http://thesaq.com/rubyonrails/">-&gt; irc</A><BR>
<A href="http://anarchaia.org/">%anarchaia</A><BR>
<A href="http://project.ioni.st/">%projectionist</A><BR>
<A href="http://pugs.blogs.com/">~audreyt</A><BR>
<A href="http://dablog.rubypal.com/">~black</A><BR>
<A href="http://www.jamesbritt.com/">~britt</A><BR>
<A href="http://www.jamisbuck.org/jamis/">~buck</A><BR>
<A href="http://tomcopeland.blogs.com/juniordeveloper/">~copeland</A><BR>
<A href="http://eigenclass.org/">~fernandez</A><BR>
<A href="http://www.chadfowler.com/">~fowler</A><BR>
<A href="http://www.loudthinking.com/">~hansson</A><BR>
<A href="http://blog.segment7.net/">~hodel</A><BR>
<A href="http://slash7.com/">~hoy/7</A><BR>
<A href="http://fhwang.net/">~hwang</A><BR>
<A href="http://blog.leetsoft.com/">~luetke</A><BR>
<A href="http://www.worldlingo.com/wl/translate?wl_lp=JA-en&wl_glossary=gl1&wl_fl=3&wl_rurl=http%3A%2F%2Fwww.rubyist.net%2F%7Ematz%2F&wl_url=http%3A%2F%2Fwww.rubyist.net%2F%7Ematz%2F&wl_g_table=-3">~matz</A><BR>
<A href="http://moonbase.rydia.net/">~mental</A><BR>
<A href="http://techno-weenie.net/">~olson</A><BR>
<A href="http://pragprog.com/pragdave">~pragdave</A><BR>
<A href="http://www.livejournal.com/users/premshree/">~premshree</A><BR>
<A href="http://kronavita.de/chris/blog/">~neukirchen</A><BR>
<A href="http://www.robbyonrails.com/">~robby</A><BR>
<A href="http://www.rousette.org.uk/">~rousette</A><BR>
<A href="http://nubyonrails.com/">~topfunky</A><BR>
<A href="http://www.jvoorhis.com/">~voorhis</A><BR>
<A href="http://onestepback.org/">~weirich</A><BR>
<A href="http://blog.zenspider.com/">~zenspider</A><BR>
        </DIV> 
 <DIV class="sidebarBox">
        <H2 class="sidebarTitle">Syndicate</H2>
        <UL>
            <LI><A href="../index.xml">RSS 2.0</A></LI>
        </UL>
        </DIV> 
 <DIV class="sidebarBox">
        <P>Built upon <A href="http://hobix.com/">Hobix</A></P>
        </DIV> 
<IMG src="../images/redhanded-duck.gif" alt="Type the Duck">
<DIV class="email">Got a story for us? <A href="../mailto:redhanded@hobix.com">E-mail it!</A></DIV>
<DIV class="technorati"><P><A href="http://www.technorati.com/profile/whytheluckystiff">Technorati Profile</A>
<A href="http://www.technorati.com/cosmos/search.html?url=http%3A%2F%2Fredhanded.hobix.com"><BR>
<IMG src="../images/bubble_icon.gif" height="20" width="24" alt="Get Conversations about RedHanded &raquo; sneaking Ruby through the system"></A>
</P>
</DIV>

</DIV>


 <DIV id="blog">
        
<DIV class="entry">
    <H2 class="entryTitle">One Small Flask of Metaprogramming Elixir
  <SPAN class="entryPermalink"><A href="../inspect/oneSmallFlaskOfMetaprogrammingElixir.html" title="Permanent link to &ldquo;One Small Flask of Metaprogramming Elixir&rdquo;">#</A></SPAN>
</H2>

<DIV class="entrySection">by <A href="http://whytheluckystiff.net/" title="Visit why&#39;s homepage">why</A> 
  in <A href="../inspect" title="List of entries in the &ldquo;inspect&rdquo; category">inspect</A>
</DIV>

     <DIV class="entryContent"><P>We could make metaprogramming easier for the common streetsfolk.  I’m not giving a triumphant answer here.  I’m just wondering what else you knobbly ducks out there have done like this.</P>


	<P>So you have this class which defines a structure for scripts within a larger program (MouseHole in this case):</P>


<PRE> class UserScript
   attr_accessor :title, :description, :version, :mount,
                 :register_uri, :rewrite
   def initialize
     @register_uri, @rewrite = [], {}
   end
 end
</PRE>

	<P>Nothing special.  But the <CODE>initialize</CODE> does tell us that <CODE>register_uri</CODE> and <CODE>rewrite</CODE> are an array and a hash, respectively.</P>


	<P>Use a <CODE>method_missing</CODE> to set the accessors based on their defaults in <CODE>initialize</CODE>:</P>


<PRE> meta_make(UserScript) do
   title "MouseCommand" 
   description "A-wiki-and-a-shell-in-one." 
   version "2.0" 

   mount :cmd do
     %{&lt;html&gt; .. &lt;/html&gt;}
   end

   rewrite HTML, XML do
     document.change_someways!
   end

   rewrite CSS do
     document.gsub! '.title', '.titleSUPERIOR'
   end

   # allow methods to be defined
   def to_gravy; end
 end
</PRE>

	<P>So, since <CODE>rewrite</CODE> was set up in <CODE>initialize</CODE> as a hash, the definition above will result in:</P>


<PRE> @title = "MouseCommand" 
 @description = "A-wiki-and-a-shell-in-one." 
 @version = "2.0" 
 @mount = [:cmd, #&lt;Proc:903e&gt;],
 @rewrite = {
   HTML =&gt; #&lt;Proc:0xf140&gt;,
   XML =&gt; #&lt;Proc:0xf140&gt;,
   CSS =&gt; #&lt;Proc:0x34a3&gt;
 }
</PRE>

	<P>It’s very Railsish, but as people are now so accustomed to that syntax, it could ease transition of Railsers to your project, whatever it be.</P>


	<P>Here’s the <CODE>meta_make</CODE> method:</P>


<PRE> def meta_make(klass, &amp;blk)
   o = klass.new
   (class &lt;&lt; o; self; end).instance_eval { @__obj = o }
   class &lt;&lt; o
     def self.method_missing(m, *args, &amp;blk)
       set_attr(m, *args, &amp;blk)
     end
     def self.set_attr(m, *args, &amp;blk)
       if blk
         args &lt;&lt; nil if args.empty?
         args &lt;&lt; blk 
       end
       v = @__obj.instance_variable_get("@#{m}")
       if v.respond_to? :to_ary
         (v = v.to_ary).push args
       elsif v.respond_to? :to_hash
         v = v.to_hash
         while args.length &gt; 1
           v[args.unshift] = args.last
         end
       elsif args.length &lt;= 1
         v = args.first
       else
         v = args
       end
       @__obj.instance_variable_set("@#{m}", v)
     end
   end
   (class &lt;&lt; o; self; end).class_eval &amp;blk
   o
 end
</PRE></DIV> 
</DIV>
<DIV class="entryFooter"> 
    <NOBR>29 Nov 2005</NOBR> at <NOBR>02:03</NOBR>
    <NOSCRIPT></NOSCRIPT>
   | 
    30 comments
</DIV>
</DIV>
<DIV id="comments">


<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>rue</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>29 Nov 2005</NOBR> at <NOBR>02:39</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P>Brilliant. (Sorry, I am all out of zany &amp; wacky.)</P></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>gmosx</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>29 Nov 2005</NOBR> at <NOBR>02:44</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P>Very cool :)</P></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>Danno</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>29 Nov 2005</NOBR> at <NOBR>03:15</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P>I… have no idea what to add.</P>


	<P>Quick question though: Any reason you decided to change up between class_eval and instance_eval when calling against the eigenclass?</P></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>nedric</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>29 Nov 2005</NOBR> at <NOBR>07:37</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P>Hmmm, it looks like @register_uri in the UserScript class gets changed to @mount in method_missing… typo?</P></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>riffraff</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>29 Nov 2005</NOBR> at <NOBR>07:39</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P>mh.. is’nt there something like this in the stdlib ? 
 IIRC  Tk does named arguments this way in ruby, since we can’t mimic the tcl syntax better</P></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>aberant</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>29 Nov 2005</NOBR> at <NOBR>10:42</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P>i’m now entirely convinced that _why is a ruby wizzard sent from the future to save mankind..</P></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>ouch</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>29 Nov 2005</NOBR> at <NOBR>13:12</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P>It makes my head hurt.  Can anyone explain in <EM>really</EM> simple words what this is about.</P></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>Daniel Berger</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>29 Nov 2005</NOBR> at <NOBR>14:34</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P>Using method_missing is a good way to create difficult to debug code.  It’s a last resort, not a first resort.</P>


	<P>Use “yield self if block_given?” as one of the first things in initialize, then just use ”||=” within initialize to set things that need setting.  Easier to read. Faster, too, I’ll bet.</P></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>MenTaLguY</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>29 Nov 2005</NOBR> at <NOBR>15:40</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P><STRONG>aberant</STRONG>: yes, it is about time we developed a mythology around him.</P>


	<P><STRONG>ouch</STRONG>: here’s the basics:</P>


	<P><CODE>meta_make(UserScript)</CODE> creates an instance of UserScript and execs the attach’d block in the context of its eigenclass (sort of as if it were <CODE>class &lt;&lt; UserScript.new</CODE>).</P>


	<P>The key is that it slips some additional bits into the eigenclass before doing so.  That call to <CODE>rewrite XML, HTML</CODE>, for example?  It hits the eigenclass’s <CODE>method_missing</CODE>, which has been made basically just a call to <CODE>set_attr</CODE>.</P>


	<P><CODE>set_attr</CODE> looks at the name of the attempted method call (<CODE>:rewrite</CODE>), yanks out <CODE>@rewrite</CODE> from the object (thoughtfully made available via <CODE>__obj</CODE>), sees it’s a hash, and merges in its parameters accordingly (each arg becomes a key, the block becomes the value).</P>


	<P>We’ve got different rules for instance variables which are arrays and so forth, but that’s the basic idea.  See the definition of <CODE>set_attr</CODE> above for the specifics.</P></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>MenTaLguY</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>29 Nov 2005</NOBR> at <NOBR>15:45</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P><STRONG>Daniel Berger</STRONG>: It is true that much of this could (should, perhaps) be done in initialize, but <CODE>yield self</CODE> is quite different to instance_exec’ing the block on the eigenclass.</P>


	<P>Perhaps, though, that makes more sense in the context of MouseHole, where UserScript is sort of a factory for one-off singletons rather than a class being used the normal way.</P>


	<P>For most purposes you could probably squish this down into less meta-ness.</P></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>MenTaLguY</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>29 Nov 2005</NOBR> at <NOBR>15:50</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P>Hmm, and it is very meta, isn’t it?  We’re adding things to the eigenclass’s own eigenclass here.</P>


<PRE><CODE>
   class &lt;&lt; o ; class &lt;&lt; self
     def set_attr(m, *args, &amp;blk)
       if blk
         args &lt;&lt; nil if args.empty?
         args &lt;&lt; blk 
       end
       v = @__obj.instance_variable_get("@#{m}")
       if v.respond_to? :to_ary
         (v = v.to_ary).push args
       elsif v.respond_to? :to_hash
         v = v.to_hash
         while args.length &gt; 1
           v[args.unshift] = args.last
         end
       elsif args.length &lt;= 1
         v = args.first
       else
         v = args
       end
       @__obj.instance_variable_set("@#{m}", v)
     end
     alias method_missing set_attr
   end end
</CODE></PRE></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>Daniel Berger</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>29 Nov 2005</NOBR> at <NOBR>16:26</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent">MenTaLguY, what does that code do that this doesn’t?
<PRE><CODE>
class UserScript
   attr_accessor :title, :description, :version,
   attr_accessor :mount, :register_uri, :rewrite
   def initialize
      yield self if block_given?

      @title       ||= "MouseCommand" 
      @description ||= "A-wiki-and-a-shell-in-one." 
      @version     ||= "2.0" 
      @mount       ||= [:cmd, lambda{ %{&lt;html&gt; .. &lt;/html&gt;}]

      @rewrite["HTML"] ||= document.change_someways!
      @rewrite["XML"]  ||= document.change_someways!
      @rewrite["CSS"]  ||=
         document.gsub!('.title','.titleSUPERIOR')
   end
end
</CODE>
</PRE></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>MenTaLguY</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>29 Nov 2005</NOBR> at <NOBR>16:28</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P>This gives me an idea.  We can secret our instance variables in in our eigenclass, can’t we?</P>


	<P>Maybe that is useful for when we are writing something meta and want to be all “hands off my instance variables”.</P>


<PRE><CODE>

class Class
  def eigen_reader( *names )
    names.each do |name|
      ivar = "@#{ name }" 
      define_method( name ) do
        (class &lt;&lt; self ; self ; end).
          instance_variable_get ivar
      end
    end
  end
  def eigen_writer( *names )
    names.each do |name|
      ivar = "@#{ name }" 
      define_method( "#{ name }=" ) do |value|
        (class &lt;&lt; self ; self ; end).
          instance_variable_set ivar, value
      end
    end
  end
  def eigen_accessor( *names )
    eigen_reader *names
    eigen_writer *names
  end
end
</CODE></PRE><CODE></CODE></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>MenTaLguY</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>29 Nov 2005</NOBR> at <NOBR>16:32</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P><STRONG>Daniel</STRONG>: with make_meta that stuff is added to an instance, not to the class.</P></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>MenTaLguY</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>29 Nov 2005</NOBR> at <NOBR>16:34</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P>make_meta?  meta_make, rather.  The meta method, for mouseHole.</P></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>MenTaLguY</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>29 Nov 2005</NOBR> at <NOBR>16:37</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P>Actually… if we’re putting stuff in eigenland, why use instance variables a’tall?</P>


<PRE><CODE>
class Class
  def magic_accessor( *names )
    names.each do |name|
      define_method( name ) { nil }
      define_method( "#{ name }=" ) do |value|
        (class &lt;&lt; self ; self ; end).class_eval do
          define_method( name ) { value }
        end
      end
    end
  end
end
</CODE></PRE></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>MenTaLguY</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>29 Nov 2005</NOBR> at <NOBR>16:48</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P>Hey, since we can have eigenclasses of eigenclasses, we can do this:</P>


<PRE><CODE>
class Object
  def meta( n=1 )
    meta = self
   n.times do
      meta = (class &lt;&lt; meta ; self ; end)
    end
    meta
 end
end
</CODE></PRE>

	<P>How meta can you go?</P>


	<P><CODE>Object.new.meta(5)</CODE></P>


	<P><CODE>=&gt; #&lt;Class:#&lt;Class:#&lt;Class:#&lt;Class:#&lt;Class:#&lt;Object:0x3247b10&gt;&gt;&gt;&gt;&gt;&gt;</CODE></P></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>why</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>29 Nov 2005</NOBR> at <NOBR>16:59</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P>To get around the <CODE>method_missing</CODE> / debug problem, I think I’d raise a noodle if there’s no setter.</P>


<PRE> raise ProblemChild unless respond_to? "#{m}=" 
</PRE>

	<P>In <CODE>set_attr</CODE>.  Dan, we’re trying to make simple scripts pretty for beginners, not reach some moral/ethical crossroad.</P></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>MenTaLguY</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>29 Nov 2005</NOBR> at <NOBR>17:10</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P>Okay soo… to bring this back on topic, here’s what things might look like doing in initialize.  Let’s give ourselves a meta_eval first, though.</P>


<PRE><CODE>
class Object
  def meta_eval( n=1, &amp;blk )
   meta( n ).instance_eval &amp;blk
  end
end
</CODE></PRE>

	<P>So, then…</P>


<PRE><CODE>
class MetaMaid
  eigen_accessor :__obj

  def initialize( &amp;blk )
    self.__obj = self
    meta_eval( 2 ) do
      def set_attr( m, *args, &amp;blk )
        # same as _why had
      end
      alias set_attr method_missing
    end
    meta_eval &amp;blk
  end
end
</CODE></PRE>

	<P>Then I think you could do like:</P>


<CODE><PRE> class UserScript &lt; MetaMaid
   attr_accessor :title, :description,
                 :version, :mount,
                 :register_uri, :rewrite
   def initialize( &amp;blk )
     @register_uri, @rewrite = [], {}
     super( &amp;blk )
   end
 end
</PRE></CODE>

	<P>And then turn out your scripts like:</P>


<PRE><CODE>
UserScript.new do
  # also same as _why had
end
</CODE></PRE>

	<P>I don’t know.  You could probably make MetaMaid a module even.</P></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>MenTaLguY</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>29 Nov 2005</NOBR> at <NOBR>17:14</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P>Er, the “back on topic” line was aimed at myself, since I’ve been astronauting the eigenspace when we should instead be looking making things friendly for the newbies.</P>


	<P>Meta-newbies might like this <CODE>Object#meta_eval</CODE> thing though.</P></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>Adharma</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>29 Nov 2005</NOBR> at <NOBR>17:51</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P>I’m trying to wrap my head around this code, but coming up a bit short. Some of the syntax is chewy. And heck, I’m new to this ruby thing anyhoo. So…</P>


	<P>What is going on with <CODE>@__obj</CODE> and <CODE>@#{m}</CODE> ? Meaning mostly the syntax.</P>


	<P>And in…</P>


<PRE><CODE>
 meta_make(UserScript) do
   title "MouseCommand" 
   description "A-wiki-and-a-shell-in-one." 
   version "2.0" 
</CODE></PRE>

	<P>I understand that “MouseCommand” is getting assigned to title, but why? how?</P>


	<P>Sorry if my questions are a bit simpleton, but I feel I am on there verge of understanding the concepts, but I don’t quite have the syntax/idiom down. Any help would be greatfully appreciated.</P>


	<P>-cheers</P></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>MenTaLguY</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>29 Nov 2005</NOBR> at <NOBR>18:07</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P>Syntactically, <CODE>@__obj</CODE> is an ordinary instance variable.  No magic in itself.</P>


<CODE>"@#{m}"</CODE> is basically the same as <CODE>"@" + m.to_s</CODE></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>MenTaLguY</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>29 Nov 2005</NOBR> at <NOBR>18:10</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P>Also, I have been subconsciously ripping off why’s metaid.  Wondered why the name <CODE>MetaMaid</CODE> seemed so natural.  <CODE>Object#meta_eval</CODE> indeed.  My only contribution is the multi-level recursion and maybe the <CODE>eigen_accessor</CODE> business.</P></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>Adharma</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>29 Nov 2005</NOBR> at <NOBR>18:42</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P>Ok, then why the double underscore? That spurs me to find meaning there. If this is essentially a primer for nubies to understand the concepts of metaprogramming, then I have a few observations/questions. Most of the Ruby code I have seen is very human readable with little short cuts in naming and when illustrating concepts syntactical shortcuts are for the most part left out. So, I might rename some of your variables such as o to eigen_object or v to eigen_instance or m to eigen_setter. I like the code, it tickles my thinking parts, especially those that are in love with self reference and recursion. It’s really exciting and I want to wrap my noggin around as soon as possible so I might add to the dialog…</P></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>Adharma</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>29 Nov 2005</NOBR> at <NOBR>18:45</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P>Oh MenTaLguY, and at some point in my mental process I apparently reascribed authorship of the code to you. Bad pointer arithmatic will get you every time.</P></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>why</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>29 Nov 2005</NOBR> at <NOBR>18:58</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P><STRONG>Adharma</STRONG>: This isn’t very good code for teaching beginners how write metaprogramming mysteries.  It is a bit of code to make use of, though.  If you understand the first three bits of code in the post above, then you can probably use the fourth without totally digesting it.</P>


	<P>The <CODE>meta_make</CODE> code is guts code.  It looks like guts and it is.</P>


	<P>The double-underscore is just stupid.  To prevent clash.  I’m actually hoping me or anyone will clean up the stuff.  I should start working on getting this post off the front page.</P></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>Danno</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>29 Nov 2005</NOBR> at <NOBR>22:23</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P>_why, your code is showing.</P>


	<P>unshift inside of the while loop in meta_make will never cause the array to shrink.  Simple typo.</P>


	<P>As for avoiding method_missing, I think I have a solution (it uses a string eval though, so I’m like “Blaaaah”)</P>


<PRE><CODE>
class Module      
  def advanced_accessor(*args)
    attr_accessor *args
    @__nuts_for_later = args
  end
end

def meta_make(klass, &amp;blk)
  retrieved_nuts = klass.instance_variable_get(:@__nuts_for_later)
  o = klass.new

  (class &lt;&lt; o; self; end).instance_eval { @__obj = o }
  (class &lt;&lt; o; self; end).instance_eval { @__retrieved_nuts = retrieved_nuts }

  class &lt;&lt; o
    @__retrieved_nuts.each do |sym|
      var_sym = (":@" + sym.to_s)
      new_method = &lt;&lt;DONE
def self.#{sym.to_s} (*args, &amp;blk)
  if blk
    args &lt;&lt; nil if args.empty?
    args &lt;&lt; blk 
  end
  v = @__obj.instance_variable_get(#{var_sym})
  if v.respond_to? :to_ary
    (v = v.to_ary).push args
  elsif v.respond_to? :to_hash
    v = v.to_hash
    while args.length &gt; 1
      v[args.shift] = args.last
    end
  elsif args.length &lt;= 1
    v = args.first
  else
    v = args
  end
  @__obj.instance_variable_set(#{var_sym}, v)
end
DONE
      class_eval(new_method)
    end
  end

  (class &lt;&lt; o; self; end).instance_eval &amp;blk

  o
end

 class UserScript
   advanced_accessor :title, :description, :version, :mount,
                 :register_uri, :rewrite
   def initialize
     @register_uri, @rewrite = [], {}
   end
 end

 meta_make(UserScript) do
   title "MouseCommand" 
   description "A-wiki-and-a-shell-in-one." 
   version "2.0" 

   mount :cmd do
     %{&lt;html&gt; .. &lt;/html&gt;}
   end

   rewrite "HTML", "XML" do
     document.change_someways!
   end

   rewrite "CSS" do
    document.gsub! '.title', '.titleSUPERIOR'
   end

   # allow methods to be defined
   def to_gravy; end
 end
</CODE>
</PRE></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>asno</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>30 Nov 2005</NOBR> at <NOBR>12:28</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><STRONG>Adharma</STRONG>: I changed the variable names in _why’s code, see if this helps you grok it better?
<PRE>def meta_make(klass, &amp;blk)

   some_class = klass.new
   (class &lt;&lt; some_class; self; end).instance_eval { @whys_temp_some_class = some_class }
   class &lt;&lt; some_class
     # Gets called when there is no method of 'name'
     def self.method_missing(name, *args, &amp;blk)
       set_attr(name, *args, &amp;blk)
     end

     def self.set_attr(method_name, *args, &amp;blk)
       if blk
         args &lt;&lt; nil if args.empty?
         args &lt;&lt; blk 
       end

       our_new_var = @whys_temp_some_class.instance_variable_get("@#{method_name}")

       if our_new_var.respond_to? :to_ary
         (our_new_var = our_new_var.to_ary).push args
       elsif our_new_var.respond_to? :to_hash
         our_new_var = our_new_var.to_hash
         while args.length &gt; 1
           our_new_var[args.unshift] = args.last
         end
       elsif args.length &lt;= 1
         our_new_var = args.first
       else
         our_new_var = args
       end

       @whys_temp_some_class.instance_variable_set("@#{method_name}", our_new_var)
     end
   end

   (class &lt;&lt; some_class; self; end).class_eval &amp;blk
   some_class
 end
</PRE></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>mo</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>01 Dec 2005</NOBR> at <NOBR>15:15</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P>Ruby beginners should look here: pleac.sf.net or here: www.rubyquiz.com.</P></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>Adharma</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>03 Dec 2005</NOBR> at <NOBR>21:20</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P>Thanks a bazillion,<B>asno</B>. This gives me a bit more to grip up on. I’ll be playing with it for the next few weeks when I head back to New Orleans.</P></DIV></DIV>
</DIV>


  <DIV class="entry">
    <P><SMALL>Comments are closed for this entry.</SMALL></P>
  



        </DIV> 

</DIV>



</DIV>





</DIV></BODY></HTML>