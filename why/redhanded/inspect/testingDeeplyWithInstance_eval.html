<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "DTD/xhtml1-transitional.dtd">
<!-- saved from url=(0105)redhanded.hobix.com/inspect/testingDeeplyWithInstance_eval.html -->
<HTML xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><HEAD><META http-equiv="Content-Type" content="text/html; charset=UTF-8">
<!--<BASE href="http://redhanded.hobix.com.wstub.archive.org/inspect/testingDeeplyWithInstance_eval.html">--><BASE href=".">


<TITLE>RedHanded » Digging Deep with Instance_eval</TITLE>
<LINK rel="shortcut icon" href="../favicon.ico" type="image/vnd.microsoft.icon" />
<LINK rel="icon" href="../favicon.ico" type="image/vnd.microsoft.icon" />
<META http-equiv="Pragma" content="no-cache">
<META http-equiv="Expires" content="-1">




<STYLE type="text/css">
 @import "../site.css"; 
</STYLE>
</HEAD><BODY>

<DIV id="page">

<DIV id="hoodwinkd">
  <A href="http://hoodwinkd.hobix.com/"><SPAN>hoodwink.d enhanced</SPAN></A>

</DIV>
<DIV id="buttons">
<DL class="tab">
  <DT><A title="Syndicate this Site" href="index.xml">RSS</A></DT>
  <DD><A title="Syndicate this Site" href="index.xml">2.0</A></DD>
</DL>
<DL class="tab xhtml">
  <DT><A title="Validate this Site" href="http://validator.w3.org/check?uri=http://redhanded.hobix.com/">XHTML</A></DT>
  <DD><A title="Validate this Site" href="http://validator.w3.org/check?uri=http://redhanded.hobix.com/">1.0</A></DD>
</DL>
</DIV>
<H1 class="title"><A href="../"><IMG src="../images/redhanded.gif" alt="RedHanded"></A></H1>
<DIV id="banner">
  <DIV class="tagline">sneaking Ruby through the system</DIV>
  <DIV class="nav"><A href="../5.gets/">5.gets</A> | <A href="../bits/">bits</A> | 
    <A href="../inspect/">inspect</A> | <A href="../cult/">the cult</A> | <A href="../-h/">-h</A></DIV>
</DIV>


<DIV id="content">
<DIV id="sidebar">
<P>New to RedHanded? <A href="../-h/pardonAndWelcome.html">About our sections.</A></P>

<DIV class="sidebarBox">
<H2 class="sidebarTitle">Archive</H2>
<UL>

    <LI><A href="../2004/12/">December 2004</A></LI>

    <LI><A href="../2005/01/">January 2005</A></LI>

    <LI><A href="../2005/02/">February 2005</A></LI>

    <LI><A href="../2005/03/">March 2005</A></LI>

    <LI><A href="../2005/04/">April 2005</A></LI>

    <LI><A href="../2005/05/">May 2005</A></LI>

    <LI><A href="../2005/06/">June 2005</A></LI>

    <LI><A href="../2005/07/">July 2005</A></LI>

    <LI><A href="../2005/08/">August 2005</A></LI>

    <LI><A href="../2005/09/">September 2005</A></LI>

    <LI><A href="../2005/10/">October 2005</A></LI>

    <LI><A href="../2005/11/">November 2005</A></LI>

    <LI><A href="../2005/12/">December 2005</A></LI>

    <LI><A href="../2006/01/">January 2006</A></LI>

    <LI><A href="../2006/02/">February 2006</A></LI>

    <LI><A href="../2006/03/">March 2006</A></LI>

    <LI><A href="../2006/04/">April 2006</A></LI>

    <LI><A href="../2006/05/">May 2006</A></LI>

    <LI><A href="../2006/06/">June 2006</A></LI>

    <LI><A href="../2006/07/">July 2006</A></LI>

    <LI><A href="../2006/08/">August 2006</A></LI>

    <LI><A href="../2006/09/">September 2006</A></LI>

    <LI><A href="../2006/10/">October 2006</A></LI>

    <LI><A href="../2006/11/">November 2006</A></LI>

    <LI><A href="../2006/12/">December 2006</A></LI>

    <LI><A href="../2007/01/">January 2007</A></LI>

    <LI><A href="../2007/02/">February 2007</A></LI>

    <LI><A href="../2007/03/">March 2007</A></LI>

    <LI><A href="../2007/04/">April 2007</A></LI>

    <LI><A href="../2007/05/">May 2007</A></LI>

</UL>
</DIV>

<P><A href="http://www.pragmaticprogrammer.com/titles/ruby/index.html"><IMG src="../images/prag-ruby-book.jpg" alt="PickAxe II"></A><BR>
<A href="http://www.pragmaticprogrammer.com/titles/ruby/index.html">Get your copy of <I>Programming Ruby</I>!</A></P>

 <DIV class="sidebarBox">
        <H2 class="sidebarTitle">Links</H2>
        <A href="http://technorati.com/tags/ruby">@technorati</A><BR>
<A href="http://del.icio.us/tag/ruby">@del.icio.us</A><BR>
<A href="http://www.flickr.com/photos/tags/ruby">@flickr</A><BR>
<A href="http://www.artima.com/articles/index.jsp?topic=ruby">@artima</A><BR>
<A href="http://blog.caboo.se/">@caboo</A><BR>
<A href="http://www.oreillynet.com/ruby">@oreilly</A><BR>
<A href="http://ruby-lang.org/">ruby</A><BR>
<A href="http://ruby-doc.org/">-&gt; docs</A><BR>
<A href="http://rubyforge.org/">-&gt; wares</A><BR>
<A href="http://rubygarden.org/ruby/">-&gt; wiki</A><BR>
<A href="http://www.sitepoint.com/forums/forumdisplay.php?f=227">-&gt; forum</A><BR>
<A href="http://www.rubyquiz.com/">-&gt; quizzes</A><BR>
<A href="http://planetruby.0x42.net/">-&gt; planet</A><BR>
<A href="http://meme.b9.com/cdates.html?channel=ruby-lang">-&gt; irc</A><BR>
<A href="http://www.rubyweeklynews.org/">rubyweeklynews</A><BR>
<A href="http://weblog.rubyonrails.com/">rails</A><BR>
<A href="http://wiki.rubyonrails.org/">-&gt; wiki</A><BR>
<A href="http://www.planetrubyonrails.org/">-&gt; planet</A><BR>
<A href="http://thesaq.com/rubyonrails/">-&gt; irc</A><BR>
<A href="http://anarchaia.org/">%anarchaia</A><BR>
<A href="http://project.ioni.st/">%projectionist</A><BR>
<A href="http://pugs.blogs.com/">~audreyt</A><BR>
<A href="http://dablog.rubypal.com/">~black</A><BR>
<A href="http://www.jamesbritt.com/">~britt</A><BR>
<A href="http://www.jamisbuck.org/jamis/">~buck</A><BR>
<A href="http://tomcopeland.blogs.com/juniordeveloper/">~copeland</A><BR>
<A href="http://eigenclass.org/">~fernandez</A><BR>
<A href="http://www.chadfowler.com/">~fowler</A><BR>
<A href="http://www.loudthinking.com/">~hansson</A><BR>
<A href="http://blog.segment7.net/">~hodel</A><BR>
<A href="http://slash7.com/">~hoy/7</A><BR>
<A href="http://fhwang.net/">~hwang</A><BR>
<A href="http://blog.leetsoft.com/">~luetke</A><BR>
<A href="http://www.worldlingo.com/wl/translate?wl_lp=JA-en&wl_glossary=gl1&wl_fl=3&wl_rurl=http%3A%2F%2Fwww.rubyist.net%2F%7Ematz%2F&wl_url=http%3A%2F%2Fwww.rubyist.net%2F%7Ematz%2F&wl_g_table=-3">~matz</A><BR>
<A href="http://moonbase.rydia.net/">~mental</A><BR>
<A href="http://techno-weenie.net/">~olson</A><BR>
<A href="http://pragprog.com/pragdave">~pragdave</A><BR>
<A href="http://www.livejournal.com/users/premshree/">~premshree</A><BR>
<A href="http://kronavita.de/chris/blog/">~neukirchen</A><BR>
<A href="http://www.robbyonrails.com/">~robby</A><BR>
<A href="http://www.rousette.org.uk/">~rousette</A><BR>
<A href="http://nubyonrails.com/">~topfunky</A><BR>
<A href="http://www.jvoorhis.com/">~voorhis</A><BR>
<A href="http://onestepback.org/">~weirich</A><BR>
<A href="http://blog.zenspider.com/">~zenspider</A><BR>
        </DIV> 
 <DIV class="sidebarBox">
        <H2 class="sidebarTitle">Syndicate</H2>
        <UL>
            <LI><A href="../index.xml">RSS 2.0</A></LI>
        </UL>
        </DIV> 
 <DIV class="sidebarBox">
        <P>Built upon <A href="http://hobix.com/">Hobix</A></P>
        </DIV> 
<IMG src="../images/redhanded-duck.gif" alt="Type the Duck">
<DIV class="email">Got a story for us? <A href="../mailto:redhanded@hobix.com">E-mail it!</A></DIV>
<DIV class="technorati"><P><A href="http://www.technorati.com/profile/whytheluckystiff">Technorati Profile</A>
<A href="http://www.technorati.com/cosmos/search.html?url=http%3A%2F%2Fredhanded.hobix.com"><BR>
<IMG src="../images/bubble_icon.gif" height="20" width="24" alt="Get Conversations about RedHanded &raquo; sneaking Ruby through the system"></A>
</P>
</DIV>

</DIV>


 <DIV id="blog">
        
<DIV class="entry">
    <H2 class="entryTitle">Digging Deep with Instance_eval
  <SPAN class="entryPermalink"><A href="../inspect/testingDeeplyWithInstance_eval.html" title="Permanent link to &ldquo;Digging Deep with Instance_eval&rdquo;">#</A></SPAN>
</H2>

<DIV class="entrySection">by <A href="http://whytheluckystiff.net/" title="Visit why&#39;s homepage">why</A> 
  in <A href="../inspect" title="List of entries in the &ldquo;inspect&rdquo; category">inspect</A>
</DIV>

     <DIV class="entryContent"><P>I feel like <CODE>instance_eval</CODE> deserves a friendlier name.  Especially when used in tandem with a block to reach down inside an object for a moment.</P>


	<P>A great example of this is on the RubyGarden wiki under <A href="http://rubygarden.org/ruby/ruby?RubyStyleGuide/InjectComplexTestsIntoObjects">RubyStyleGuide/InjectComplexTestsIntoObjects</A>. The challenge is to reduce the redundancy of the below.</P>


<PRE> f = open("myfile")
 if f.stat.readable? and f.stat.writable? and f.stat.size? and f.stat.owned?
   # work with file
 end
</PRE>

	<P>My favorite solution involves <CODE>instance_eval</CODE>, but see how long and ugly it looks?  Perhaps an answer would be aliasing a name like <CODE>within</CODE> for simple block calls to <CODE>instance_eval</CODE>.</P>


<PRE> f = open("myfile")    
 if f.stat.instance_eval{ readable? and writable? and size? and owned? }
   # work with file
 end
</PRE></DIV> 
</DIV>
<DIV class="entryFooter"> 
    <NOBR>01 Jun 2005</NOBR> at <NOBR>16:37</NOBR>
    <NOSCRIPT></NOSCRIPT>
   | 
    13 comments
</DIV>
</DIV>
<DIV id="comments">


<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>MenTaLguY</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>01 Jun 2005</NOBR> at <NOBR>16:56</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P>Used that way, it’s a bit like a <CODE>with</CODE> block in Visual Basic, actually.</P>


	<P>(Horrid comparison, I know, but it’s the first thing that came to mind.  And it is a convenient thing sometimes.)</P></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>MenTaLguY</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>01 Jun 2005</NOBR> at <NOBR>17:03</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P>Ah, I see someone’s actually gone and done an Object#with, though employing method_missing? to do it.</P>


	<P>The disadvantage of instance_eval over the method_missing? is that you can’t easily call private methods from the enclosing scope.</P>


	<P>Doesn’t matter for what you’re trying to do here, but it’s limiting in more general usage.</P></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>MenTaLguY</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>01 Jun 2005</NOBR> at <NOBR>17:16</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P>Another solution for minimizing redundancy in this particular case might be:</P>


<PRE><CODE>
f = open("myfile")
if %w{readable? writable? size? owned?}.inject(true) {|o,p| o and f.stat.send p}
  # work with file
end
</CODE></PRE>

	<P>Heh.  Horrid, no?</P></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>BloodyEll</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>01 Jun 2005</NOBR> at <NOBR>17:27</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P>I think MenTaLguY needs a spanking for that last one.</P></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>timsuth</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>01 Jun 2005</NOBR> at <NOBR>18:33</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P>How about</P>


<CODE>
<PRE>f = open("myfile")
if %w{readable? writable? size? owned?}.all? { |m| f.stat.send(m) }
  # work with file
end
</PRE>
</CODE></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>MrCode</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>01 Jun 2005</NOBR> at <NOBR>21:56</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P>f.stat is called for each invocation of the block for MenTaLguY and timsuth’s examples, which could be inefficient. So a separate variable is needed for best efficiency. Or instance_eval could be used, but that gets real ugly:</P>


<PRE><CODE>
f = open("myfile")
if f.stat.instance_eval { %w{readable? writable? size? owned?}.all? { |m| send(m) } }
  # work with file
end
</CODE>
</PRE>

	<P>By the way, here is another version:</P>


<PRE><CODE>
f = open("myfile")
if f.stat.instance_eval { eval(%w{readable? writable? size? owned?}.join(' and ')) }
  # work with file
end
</CODE>
</PRE>

	<P>Not all that clever, but just obfuscated enough to be interesting ;)</P>


	<P>Hey _why, what is wrong with the “is?” method created on the above linked page? That sure looks clean to me…</P></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>zem</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>01 Jun 2005</NOBR> at <NOBR>23:09</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P>What would be nice would be a method to do a series of sends to an object and collect the results. (“Collect” would actually be a great name for this, shame it’s a synonym for “map” instead).</P>


<PRE><CODE>
f = open("myfile")
if f.stat.collect [:readable?, :writable?, :size?, :owned?].all?
   # work with file
end
</CODE>
</PRE></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>why</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>02 Jun 2005</NOBR> at <NOBR>00:13</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P><STRONG>MrCode:</STRONG> nothing wrong with it.  How would you do “or” logic with it, if you wanted?  I guess multiple “is?” calls.</P></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>murphy</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>02 Jun 2005</NOBR> at <NOBR>03:22</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P>I think Ruby has other ways to mimic a with-like behaviour.</P>


	<P>My favorite: Extending classes.</P>


<PRE>class File::Stat
    def usable?
 readable? and writable? and size? and owned?
    end
end

if open('myFile').stat.usable?
    # use it
end
</PRE>

	<P>It seems logical that the File::Stat object is responsible for managing that.</P></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>bleh</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>02 Jun 2005</NOBR> at <NOBR>12:51</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P>no pls, not yet another reinvention of</P>


<PRE><CODE>
 def with(x,&amp;b);x.instance_eval(&amp;b) end
</CODE>
</PRE>

	<P>I find the one based on method_missing ugly. Not thread-safe, too much code…</P></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>MenTaLguY</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>02 Jun 2005</NOBR> at <NOBR>16:59</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P>You could make a threadsafe one actually.</P>


<PRE><CODE>
class DoubleDelegate
  def initialize(a, b)
    @a = a
    @b = b
  end
  def method_missing(method, *args, &amp;block)
    if @a.respond_to?(method, true)
 @a
    else
      @b
    end.send(method, *args, &amp;block)
  end
end

module Kernel
  def with(o, &amp;block)
    DoubleDelegate::new(o, self).instance_eval &amp;block
  end
  private :with
end
</CODE></PRE>

	<P>Wouldn’t have immediate access to the object’s instance variables, but if you did you’d be using instance_eval anyway.</P>


	<P>Private methods will be dispatched to the object passed as a parameter to with, if it responds to them, else they will be dispatched in the calling context.</P>


	<P>Of course this won’t work totally.  Object/Kernel methods on DoubleDelegate will take the highest precedence of all.</P>


	<P>You can have DoubleDelegate undefine any methods it gets from its ancestors, or you can find some way to make DoubleDelegate a class that doesn’t inherit from Object or Kernel.</P></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>MenTaLguY</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>02 Jun 2005</NOBR> at <NOBR>17:13</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P>I imagine this sort of thing is why Matz wants a “bare” superclass for Object, actually.</P></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>MenTaLguY</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>02 Jun 2005</NOBR> at <NOBR>17:26</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P>Until then I suppose you can do something like this, if you have Evil Ruby or similar installed to get Object#class=</P>


<PRE><CODE>
Yorick = Class::allocate
class Yorick
  def self.allocate
    o = Object::new
    o.class = Yorick
    o
  end
  def self.new(*args, block)
    o = allocate
 o.send(:initialize, *args, &amp;block) \
      if o.respond_to?(:initialize, true)
    o
  end
end

class DoubleDelegate &lt; Yorick
  ... etc
end
</CODE></PRE>

	<P>Untested.  If you try it and open a portal to Hell or something, you were warned.</P></DIV></DIV>
</DIV>


  <DIV class="entry">
    <P><SMALL>Comments are closed for this entry.</SMALL></P>
  



        </DIV> 

</DIV>



</DIV>





</DIV></BODY></HTML>