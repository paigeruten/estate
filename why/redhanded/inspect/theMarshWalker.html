<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "DTD/xhtml1-transitional.dtd">
<!-- saved from url=(0089)redhanded.hobix.com/inspect/theMarshWalker.html -->
<HTML xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><HEAD><META http-equiv="Content-Type" content="text/html; charset=UTF-8">
<!--<BASE href="http://redhanded.hobix.com.wstub.archive.org/inspect/theMarshWalker.html">--><BASE href=".">


<TITLE>RedHanded » PickPocket, a Marshal Ransack Hack</TITLE>
<LINK rel="shortcut icon" href="../favicon.ico" type="image/vnd.microsoft.icon" />
<LINK rel="icon" href="../favicon.ico" type="image/vnd.microsoft.icon" />
<META http-equiv="Pragma" content="no-cache">
<META http-equiv="Expires" content="-1">




<STYLE type="text/css">
 @import "../site.css"; 
</STYLE>
</HEAD><BODY>

<DIV id="page">

<DIV id="hoodwinkd">
  <A href="http://hoodwinkd.hobix.com/"><SPAN>hoodwink.d enhanced</SPAN></A>

</DIV>
<DIV id="buttons">
<DL class="tab">
  <DT><A title="Syndicate this Site" href="index.xml">RSS</A></DT>
  <DD><A title="Syndicate this Site" href="index.xml">2.0</A></DD>
</DL>
<DL class="tab xhtml">
  <DT><A title="Validate this Site" href="http://validator.w3.org/check?uri=http://redhanded.hobix.com/">XHTML</A></DT>
  <DD><A title="Validate this Site" href="http://validator.w3.org/check?uri=http://redhanded.hobix.com/">1.0</A></DD>
</DL>
</DIV>
<H1 class="title"><A href="../"><IMG src="../images/redhanded.gif" alt="RedHanded"></A></H1>
<DIV id="banner">
  <DIV class="tagline">sneaking Ruby through the system</DIV>
  <DIV class="nav"><A href="../5.gets/">5.gets</A> | <A href="../bits/">bits</A> | 
    <A href="../inspect/">inspect</A> | <A href="../cult/">the cult</A> | <A href="../-h/">-h</A></DIV>
</DIV>


<DIV id="content">
<DIV id="sidebar">
<P>New to RedHanded? <A href="../-h/pardonAndWelcome.html">About our sections.</A></P>

<DIV class="sidebarBox">
<H2 class="sidebarTitle">Archive</H2>
<UL>

    <LI><A href="../2004/12/">December 2004</A></LI>

    <LI><A href="../2005/01/">January 2005</A></LI>

    <LI><A href="../2005/02/">February 2005</A></LI>

    <LI><A href="../2005/03/">March 2005</A></LI>

    <LI><A href="../2005/04/">April 2005</A></LI>

    <LI><A href="../2005/05/">May 2005</A></LI>

    <LI><A href="../2005/06/">June 2005</A></LI>

    <LI><A href="../2005/07/">July 2005</A></LI>

    <LI><A href="../2005/08/">August 2005</A></LI>

    <LI><A href="../2005/09/">September 2005</A></LI>

    <LI><A href="../2005/10/">October 2005</A></LI>

    <LI><A href="../2005/11/">November 2005</A></LI>

    <LI><A href="../2005/12/">December 2005</A></LI>

    <LI><A href="../2006/01/">January 2006</A></LI>

    <LI><A href="../2006/02/">February 2006</A></LI>

    <LI><A href="../2006/03/">March 2006</A></LI>

    <LI><A href="../2006/04/">April 2006</A></LI>

    <LI><A href="../2006/05/">May 2006</A></LI>

    <LI><A href="../2006/06/">June 2006</A></LI>

    <LI><A href="../2006/07/">July 2006</A></LI>

    <LI><A href="../2006/08/">August 2006</A></LI>

    <LI><A href="../2006/09/">September 2006</A></LI>

    <LI><A href="../2006/10/">October 2006</A></LI>

    <LI><A href="../2006/11/">November 2006</A></LI>

    <LI><A href="../2006/12/">December 2006</A></LI>

    <LI><A href="../2007/01/">January 2007</A></LI>

    <LI><A href="../2007/02/">February 2007</A></LI>

    <LI><A href="../2007/03/">March 2007</A></LI>

    <LI><A href="../2007/04/">April 2007</A></LI>

    <LI><A href="../2007/05/">May 2007</A></LI>

</UL>
</DIV>

<P><A href="http://www.pragmaticprogrammer.com/titles/ruby/index.html"><IMG src="../images/prag-ruby-book.jpg" alt="PickAxe II"></A><BR>
<A href="http://www.pragmaticprogrammer.com/titles/ruby/index.html">Get your copy of <I>Programming Ruby</I>!</A></P>

 <DIV class="sidebarBox">
        <H2 class="sidebarTitle">Links</H2>
        <A href="http://technorati.com/tags/ruby">@technorati</A><BR>
<A href="http://del.icio.us/tag/ruby">@del.icio.us</A><BR>
<A href="http://www.flickr.com/photos/tags/ruby">@flickr</A><BR>
<A href="http://www.artima.com/articles/index.jsp?topic=ruby">@artima</A><BR>
<A href="http://blog.caboo.se/">@caboo</A><BR>
<A href="http://www.oreillynet.com/ruby">@oreilly</A><BR>
<A href="http://ruby-lang.org/">ruby</A><BR>
<A href="http://ruby-doc.org/">-&gt; docs</A><BR>
<A href="http://rubyforge.org/">-&gt; wares</A><BR>
<A href="http://rubygarden.org/ruby/">-&gt; wiki</A><BR>
<A href="http://www.sitepoint.com/forums/forumdisplay.php?f=227">-&gt; forum</A><BR>
<A href="http://www.rubyquiz.com/">-&gt; quizzes</A><BR>
<A href="http://planetruby.0x42.net/">-&gt; planet</A><BR>
<A href="http://meme.b9.com/cdates.html?channel=ruby-lang">-&gt; irc</A><BR>
<A href="http://www.rubyweeklynews.org/">rubyweeklynews</A><BR>
<A href="http://weblog.rubyonrails.com/">rails</A><BR>
<A href="http://wiki.rubyonrails.org/">-&gt; wiki</A><BR>
<A href="http://www.planetrubyonrails.org/">-&gt; planet</A><BR>
<A href="http://thesaq.com/rubyonrails/">-&gt; irc</A><BR>
<A href="http://anarchaia.org/">%anarchaia</A><BR>
<A href="http://project.ioni.st/">%projectionist</A><BR>
<A href="http://pugs.blogs.com/">~audreyt</A><BR>
<A href="http://dablog.rubypal.com/">~black</A><BR>
<A href="http://www.jamesbritt.com/">~britt</A><BR>
<A href="http://www.jamisbuck.org/jamis/">~buck</A><BR>
<A href="http://tomcopeland.blogs.com/juniordeveloper/">~copeland</A><BR>
<A href="http://eigenclass.org/">~fernandez</A><BR>
<A href="http://www.chadfowler.com/">~fowler</A><BR>
<A href="http://www.loudthinking.com/">~hansson</A><BR>
<A href="http://blog.segment7.net/">~hodel</A><BR>
<A href="http://slash7.com/">~hoy/7</A><BR>
<A href="http://fhwang.net/">~hwang</A><BR>
<A href="http://blog.leetsoft.com/">~luetke</A><BR>
<A href="http://www.worldlingo.com/wl/translate?wl_lp=JA-en&wl_glossary=gl1&wl_fl=3&wl_rurl=http%3A%2F%2Fwww.rubyist.net%2F%7Ematz%2F&wl_url=http%3A%2F%2Fwww.rubyist.net%2F%7Ematz%2F&wl_g_table=-3">~matz</A><BR>
<A href="http://moonbase.rydia.net/">~mental</A><BR>
<A href="http://techno-weenie.net/">~olson</A><BR>
<A href="http://pragprog.com/pragdave">~pragdave</A><BR>
<A href="http://www.livejournal.com/users/premshree/">~premshree</A><BR>
<A href="http://kronavita.de/chris/blog/">~neukirchen</A><BR>
<A href="http://www.robbyonrails.com/">~robby</A><BR>
<A href="http://www.rousette.org.uk/">~rousette</A><BR>
<A href="http://nubyonrails.com/">~topfunky</A><BR>
<A href="http://www.jvoorhis.com/">~voorhis</A><BR>
<A href="http://onestepback.org/">~weirich</A><BR>
<A href="http://blog.zenspider.com/">~zenspider</A><BR>
        </DIV> 
 <DIV class="sidebarBox">
        <H2 class="sidebarTitle">Syndicate</H2>
        <UL>
            <LI><A href="../index.xml">RSS 2.0</A></LI>
        </UL>
        </DIV> 
 <DIV class="sidebarBox">
        <P>Built upon <A href="http://hobix.com/">Hobix</A></P>
        </DIV> 
<IMG src="../images/redhanded-duck.gif" alt="Type the Duck">
<DIV class="email">Got a story for us? <A href="../mailto:redhanded@hobix.com">E-mail it!</A></DIV>
<DIV class="technorati"><P><A href="http://www.technorati.com/profile/whytheluckystiff">Technorati Profile</A>
<A href="http://www.technorati.com/cosmos/search.html?url=http%3A%2F%2Fredhanded.hobix.com"><BR>
<IMG src="../images/bubble_icon.gif" height="20" width="24" alt="Get Conversations about RedHanded &raquo; sneaking Ruby through the system"></A>
</P>
</DIV>

</DIV>


 <DIV id="blog">
        
<DIV class="entry">
    <H2 class="entryTitle">PickPocket, a Marshal Ransack Hack
  <SPAN class="entryPermalink"><A href="../inspect/theMarshWalker.html" title="Permanent link to &ldquo;PickPocket, a Marshal Ransack Hack&rdquo;">#</A></SPAN>
</H2>

<DIV class="entrySection">by <A href="http://whytheluckystiff.net/" title="Visit why&#39;s homepage">why</A> 
  in <A href="../inspect" title="List of entries in the &ldquo;inspect&rdquo; category">inspect</A>
</DIV>

     <DIV class="entryContent"><P>Today’s hack is a Marshal hack, which is a highly common (but quite untapped) language that also has no formal layout beyond what Ruby’s source code has to say.  Most times you only hear about slight changes between major Ruby versions (1.6 -&gt; 1.8) when something goes <EM>kaput</EM>.  No Ruby books I know of go near dissecting it.  And, strangely enough, Minero’s classic Ruby Hacking Guide doesn’t even touch it.</P>


	<P>We are voodoo doctors.  Take us to the center of the marsh.</P>


	<H2>Tasting Just a Few Sample Bytes</H2>


	<P>Marshal is the ultra-slim encoded bytespeak that Ruby can pull out when siphoning objects through a skinny straw.  For when your Ruby shares a malt with someone else’s Ruby.  Yeah, well, it’s actually very easy to pick up.</P>


<PRE> &gt;&gt; Marshal.dump("Koichi")
 =&gt; "\004\010\"\vKoichi" 
</PRE>

	<P>Say, that’s not too bad.  We dumped out a little Marshal and you can at least see plain old <CODE>Koichi</CODE> in there.  Other than that there are just four other characters, starting with <CODE>"\004\010"</CODE>, which is the Marshal 4.8 (current) marshal header.</P>


	<P>The other characters are a quote (<CODE>"</CODE>), which means “look, a string is coming up”.  And <CODE>\v</CODE>, which is a string length.</P>


<PRE> &gt;&gt; "\v"[0] - 5
 =&gt; 6
</PRE>

	<P>Yeah, it takes a little math, but there you can see it: <CODE>\v</CODE> means a string length of 6.  So, in summary: <STRONG>this is a Ruby 1.8.4 Marshal string containing a string with six characters and they are <CODE>Koichi</CODE>.</STRONG></P>


	<H2>Skipping Bytes</H2>


	<P>Okay, so, it turns out that everything that gets Marshalled comes with these offset bytes (like <CODE>\v</CODE> above) which measure strings and hashes and arrays and floats.  (So does Python’s pickle and many other binary serialization formats.)</P>


	<P>The PickPocket hack is based on these two ideas:</P>


	<OL>
	<LI>You can skip through marshalled objects pretty easily.</LI>
		<LI>By slapping a header in the middle of a marsh, you can load only certain fragments.</LI>
	</OL>


	<P>Take this array:</P>


<PRE> &gt;&gt; Marshal.dump ["Goto80", "Treewave", "YMCK"]
 =&gt; "\004\010[\010\"\vGoto80\"\rTreewave\"\tYMCK" 
</PRE>

	<P>This Marshal reads out loud like this:</P>


<PRE> Header, Array(3)[ String(6), String(8), String(4) ]
</PRE>

	<P>So, if we want to load the second element, we can do some math to find where that element lives in the marsh.  Skip the header (2 bytes), skip the Array counter (2 bytes), skip the first string (2 bytes + 6 bytes)... which leaves us at position 12.</P>


	<P>Now, will it let us load from the middle of the Array?  Or what?</P>


<PRE> &gt;&gt; str = "\004\010[\010\"\vGoto80\"\rTreewave\"\tYMCK"[12..-1]
 =&gt; "\"\rTreewave\"\tYMCK" 
 &gt;&gt; Marshal.load(str)
 TypeError: incompatible marshal file format (can't be read)
        format version 4.8 required; 34.13 given
</PRE>

	<P>Oh, wait!  The header!</P>


<PRE> &gt;&gt; Marshal.load("\004\010" + str)
 =&gt; "Treewave" 
</PRE>

	<P>Hey, klawboom!!  That worked.  It loaded the object and ignored anything after it.</P>


	<H2>Picking Pockets</H2>


	<P>The final part of this hack is to come up with the code for walking down into the marsh and coming up with the object we want.  Here’s what I’ve got in mind.</P>


	<P>Let’s use, as our sample corpus, a marshalled dump of the RubyGems repository.  It’s of a nice, wieldsome size (2M) and it would be nice to reach in and grab one gem.</P>


<PRE>  &gt;&gt; PickPocket(File.read('rubygems.m')).gems['hpricot-0.4-mswin32'].get
  =&gt; #&lt;Gem::Specification:0x811b124 @name="hpricot" ...&gt;
</PRE>

	<P>Instead of actually loading all the objects in the dump, this query is executed when the <CODE>get</CODE> method is run.  It’ll search the <A href="http://whytheluckystiff.net/ruby/pickpocket-rubygems.m">rubygems.m</A> file for a <CODE>gems</CODE> instance variable.  And then it’ll search that variable for an <CODE>'hpricot-0.4-mswin32'</CODE> key.</P>


	<P>So far, it all fits in about a hundred lines of code: <A href="http://whytheluckystiff.net/ruby/pickpocket.rb">pickpocket.rb</A>.  More marshal hacking tomorrow.</P>


	<P class="update"><STRONG>Update:</STRONG> The RubySpec wiki has started a page on <A href="http://www.headius.com/rubyspec/index.php/Marshaling">the Marshal format</A> which looks to be a good start.</P></DIV> 
</DIV>
<DIV class="entryFooter"> 
    <NOBR>08 Nov 2006</NOBR> at <NOBR>02:25</NOBR>
    <NOSCRIPT></NOSCRIPT>
   | 
    7 comments
</DIV>
</DIV>
<DIV id="comments">


<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>Riduidel</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>08 Nov 2006</NOBR> at <NOBR>03:24</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P>Doesn’t it look like a plain old pointer ladder throwed just in the middle of our Ruby jewelry store ? Well, as far as it is done night-time (which is needed for pick-pocketing), that’s first class robbery.</P></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>hgs</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>08 Nov 2006</NOBR> at <NOBR>04:09</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P>If we are talking robbery and devious behaviour, I can’t help wondering about buffer overrun attacks, though unless this stuff gets executed I can’t see how to implement, or more importantly, detect such an attack.</P>


	<P>(Oh, this interface has a spelling checker now.  It doesn’t like my British spelling of /behavio(?:u?)r/.)</P></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>Daniel Berger</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>08 Nov 2006</NOBR> at <NOBR>08:08</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P>I’m curious what you think of the notion of Marshal.dump creating a subclass of String.  See ruby-talk:76055 for more fo what I mean.</P>


	<P>With a MarshalledString class, we could add methods that would make it easier (or at least more obvious) to do what you’re doing here.</P></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>MenTaLguY</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>08 Nov 2006</NOBR> at <NOBR>17:36</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P>Hmm, you think maybe rewriting marsh’d strings is the way forward with proxying in sandbox?</P></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>J`ey</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>08 Nov 2006</NOBR> at <NOBR>17:49</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P>Clever! What I have come to expect!</P></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>J`ey</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>09 Nov 2006</NOBR> at <NOBR>01:48</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P>Can you read on a certain part of a file? If you could, then you delay reading until the asking for something.</P></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>hgs</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>09 Nov 2006</NOBR> at <NOBR>05:00</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P>Re: update. So that’s the weirdness with packed integers! And the ; construct is half-way to Lempel-Ziv encoding. Impressive. Thank you for this.</P></DIV></DIV>
</DIV>


<DIV class="entry">
<FORM name="userComment" method="post" action="/api/comment/inspect/theMarshWalker">
  <DIV class="entryAttrib">
     <DIV class="entryAuthor"><INPUT name="sayor" type="textbox" size="15" maxlength="50"></DIV>
     <DIV id="liveTime" class="entryTime"><NOBR>11 Jul 2010</NOBR> at <NOBR>20:55</NOBR></DIV>
  </DIV>
  <DIV class="entryContentOuter"><DIV class="entryContent">
     <INPUT type="hidden" name="timestamp" value="yopYLare1A">
     <TEXTAREA name="consay" rows="6" cols="50"></TEXTAREA>
     <P><INPUT type="button" name="pleasePreview" value="preview" onclick="liveTextilePreview(document.forms[&#39;userComment&#39;].elements[&#39;consay&#39;], &#39;textilePreview&#39;, &#39;/api/preview&#39;)">
        <INPUT type="submit" name="submit" value="&gt;&gt;">
        <SMALL>* do <A href="../javascript:quickRedReference();">fancy stuff</A> in your comment.</SMALL>
     </P>
     <DIV id="textileWrap"><H4>PREVIEW PANE</H4>
     <DIV id="textilePreview"></DIV>
     </DIV>
     </DIV>
  </DIV></FORM></DIV>
  



        </DIV> 

</DIV>



</DIV>





</BODY></HTML>