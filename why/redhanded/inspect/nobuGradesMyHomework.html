<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "DTD/xhtml1-transitional.dtd">
<!-- saved from url=(0095)redhanded.hobix.com/inspect/nobuGradesMyHomework.html -->
<HTML xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><HEAD><META http-equiv="Content-Type" content="text/html; charset=UTF-8">
<!--<BASE href="http://redhanded.hobix.com.wstub.archive.org/inspect/nobuGradesMyHomework.html">--><BASE href=".">


<TITLE>RedHanded » Nobu Grades My Homework</TITLE>
<LINK rel="shortcut icon" href="../favicon.ico" type="image/vnd.microsoft.icon" />
<LINK rel="icon" href="../favicon.ico" type="image/vnd.microsoft.icon" />
<META http-equiv="Pragma" content="no-cache">
<META http-equiv="Expires" content="-1">




<STYLE type="text/css">
 @import "../site.css"; 
</STYLE>
</HEAD><BODY>

<DIV id="page">

<DIV id="hoodwinkd">
  <A href="http://hoodwinkd.hobix.com/"><SPAN>hoodwink.d enhanced</SPAN></A>

</DIV>
<DIV id="buttons">
<DL class="tab">
  <DT><A title="Syndicate this Site" href="index.xml">RSS</A></DT>
  <DD><A title="Syndicate this Site" href="index.xml">2.0</A></DD>
</DL>
<DL class="tab xhtml">
  <DT><A title="Validate this Site" href="http://validator.w3.org/check?uri=http://redhanded.hobix.com/">XHTML</A></DT>
  <DD><A title="Validate this Site" href="http://validator.w3.org/check?uri=http://redhanded.hobix.com/">1.0</A></DD>
</DL>
</DIV>
<H1 class="title"><A href="../"><IMG src="../images/redhanded.gif" alt="RedHanded"></A></H1>
<DIV id="banner">
  <DIV class="tagline">sneaking Ruby through the system</DIV>
  <DIV class="nav"><A href="../5.gets/">5.gets</A> | <A href="../bits/">bits</A> | 
    <A href="../inspect/">inspect</A> | <A href="../cult/">the cult</A> | <A href="../-h/">-h</A></DIV>
</DIV>


<DIV id="content">
<DIV id="sidebar">
<P>New to RedHanded? <A href="../-h/pardonAndWelcome.html">About our sections.</A></P>

<DIV class="sidebarBox">
<H2 class="sidebarTitle">Archive</H2>
<UL>

    <LI><A href="../2004/12/">December 2004</A></LI>

    <LI><A href="../2005/01/">January 2005</A></LI>

    <LI><A href="../2005/02/">February 2005</A></LI>

    <LI><A href="../2005/03/">March 2005</A></LI>

    <LI><A href="../2005/04/">April 2005</A></LI>

    <LI><A href="../2005/05/">May 2005</A></LI>

    <LI><A href="../2005/06/">June 2005</A></LI>

    <LI><A href="../2005/07/">July 2005</A></LI>

    <LI><A href="../2005/08/">August 2005</A></LI>

    <LI><A href="../2005/09/">September 2005</A></LI>

    <LI><A href="../2005/10/">October 2005</A></LI>

    <LI><A href="../2005/11/">November 2005</A></LI>

    <LI><A href="../2005/12/">December 2005</A></LI>

    <LI><A href="../2006/01/">January 2006</A></LI>

    <LI><A href="../2006/02/">February 2006</A></LI>

    <LI><A href="../2006/03/">March 2006</A></LI>

    <LI><A href="../2006/04/">April 2006</A></LI>

    <LI><A href="../2006/05/">May 2006</A></LI>

    <LI><A href="../2006/06/">June 2006</A></LI>

    <LI><A href="../2006/07/">July 2006</A></LI>

    <LI><A href="../2006/08/">August 2006</A></LI>

    <LI><A href="../2006/09/">September 2006</A></LI>

    <LI><A href="../2006/10/">October 2006</A></LI>

    <LI><A href="../2006/11/">November 2006</A></LI>

    <LI><A href="../2006/12/">December 2006</A></LI>

    <LI><A href="../2007/01/">January 2007</A></LI>

    <LI><A href="../2007/02/">February 2007</A></LI>

    <LI><A href="../2007/03/">March 2007</A></LI>

    <LI><A href="../2007/04/">April 2007</A></LI>

    <LI><A href="../2007/05/">May 2007</A></LI>

</UL>
</DIV>

<P><A href="http://www.pragmaticprogrammer.com/titles/ruby/index.html"><IMG src="../images/prag-ruby-book.jpg" alt="PickAxe II"></A><BR>
<A href="http://www.pragmaticprogrammer.com/titles/ruby/index.html">Get your copy of <I>Programming Ruby</I>!</A></P>

 <DIV class="sidebarBox">
        <H2 class="sidebarTitle">Links</H2>
        <A href="http://technorati.com/tags/ruby">@technorati</A><BR>
<A href="http://del.icio.us/tag/ruby">@del.icio.us</A><BR>
<A href="http://www.flickr.com/photos/tags/ruby">@flickr</A><BR>
<A href="http://www.artima.com/articles/index.jsp?topic=ruby">@artima</A><BR>
<A href="http://blog.caboo.se/">@caboo</A><BR>
<A href="http://www.oreillynet.com/ruby">@oreilly</A><BR>
<A href="http://ruby-lang.org/">ruby</A><BR>
<A href="http://ruby-doc.org/">-&gt; docs</A><BR>
<A href="http://rubyforge.org/">-&gt; wares</A><BR>
<A href="http://rubygarden.org/ruby/">-&gt; wiki</A><BR>
<A href="http://www.sitepoint.com/forums/forumdisplay.php?f=227">-&gt; forum</A><BR>
<A href="http://www.rubyquiz.com/">-&gt; quizzes</A><BR>
<A href="http://planetruby.0x42.net/">-&gt; planet</A><BR>
<A href="http://meme.b9.com/cdates.html?channel=ruby-lang">-&gt; irc</A><BR>
<A href="http://www.rubyweeklynews.org/">rubyweeklynews</A><BR>
<A href="http://weblog.rubyonrails.com/">rails</A><BR>
<A href="http://wiki.rubyonrails.org/">-&gt; wiki</A><BR>
<A href="http://www.planetrubyonrails.org/">-&gt; planet</A><BR>
<A href="http://thesaq.com/rubyonrails/">-&gt; irc</A><BR>
<A href="http://anarchaia.org/">%anarchaia</A><BR>
<A href="http://project.ioni.st/">%projectionist</A><BR>
<A href="http://pugs.blogs.com/">~audreyt</A><BR>
<A href="http://dablog.rubypal.com/">~black</A><BR>
<A href="http://www.jamesbritt.com/">~britt</A><BR>
<A href="http://www.jamisbuck.org/jamis/">~buck</A><BR>
<A href="http://tomcopeland.blogs.com/juniordeveloper/">~copeland</A><BR>
<A href="http://eigenclass.org/">~fernandez</A><BR>
<A href="http://www.chadfowler.com/">~fowler</A><BR>
<A href="http://www.loudthinking.com/">~hansson</A><BR>
<A href="http://blog.segment7.net/">~hodel</A><BR>
<A href="http://slash7.com/">~hoy/7</A><BR>
<A href="http://fhwang.net/">~hwang</A><BR>
<A href="http://blog.leetsoft.com/">~luetke</A><BR>
<A href="http://www.worldlingo.com/wl/translate?wl_lp=JA-en&wl_glossary=gl1&wl_fl=3&wl_rurl=http%3A%2F%2Fwww.rubyist.net%2F%7Ematz%2F&wl_url=http%3A%2F%2Fwww.rubyist.net%2F%7Ematz%2F&wl_g_table=-3">~matz</A><BR>
<A href="http://moonbase.rydia.net/">~mental</A><BR>
<A href="http://techno-weenie.net/">~olson</A><BR>
<A href="http://pragprog.com/pragdave">~pragdave</A><BR>
<A href="http://www.livejournal.com/users/premshree/">~premshree</A><BR>
<A href="http://kronavita.de/chris/blog/">~neukirchen</A><BR>
<A href="http://www.robbyonrails.com/">~robby</A><BR>
<A href="http://www.rousette.org.uk/">~rousette</A><BR>
<A href="http://nubyonrails.com/">~topfunky</A><BR>
<A href="http://www.jvoorhis.com/">~voorhis</A><BR>
<A href="http://onestepback.org/">~weirich</A><BR>
<A href="http://blog.zenspider.com/">~zenspider</A><BR>
        </DIV> 
 <DIV class="sidebarBox">
        <H2 class="sidebarTitle">Syndicate</H2>
        <UL>
            <LI><A href="../index.xml">RSS 2.0</A></LI>
        </UL>
        </DIV> 
 <DIV class="sidebarBox">
        <P>Built upon <A href="http://hobix.com/">Hobix</A></P>
        </DIV> 
<IMG src="../images/redhanded-duck.gif" alt="Type the Duck">
<DIV class="email">Got a story for us? <A href="../mailto:redhanded@hobix.com">E-mail it!</A></DIV>
<DIV class="technorati"><P><A href="http://www.technorati.com/profile/whytheluckystiff">Technorati Profile</A>
<A href="http://www.technorati.com/cosmos/search.html?url=http%3A%2F%2Fredhanded.hobix.com"><BR>
<IMG src="../images/bubble_icon.gif" height="20" width="24" alt="Get Conversations about RedHanded &raquo; sneaking Ruby through the system"></A>
</P>
</DIV>

</DIV>


 <DIV id="blog">
        
<DIV class="entry">
    <H2 class="entryTitle">Nobu Grades My Homework
  <SPAN class="entryPermalink"><A href="../inspect/nobuGradesMyHomework.html" title="Permanent link to &ldquo;Nobu Grades My Homework&rdquo;">#</A></SPAN>
</H2>

<DIV class="entrySection">by <A href="http://whytheluckystiff.net/" title="Visit why&#39;s homepage">why</A> 
  in <A href="../inspect" title="List of entries in the &ldquo;inspect&rdquo; category">inspect</A>
</DIV>

     <DIV class="entryContent"><P>It’s like I’ve got these superintellegent falcons looking over my shoulders.  And, occassionally, when I truly screw up, they swoop down and wrest the keyboard from me and pound up some superior extension code.  And I’m fine with these superintellegent falcons.  I would feed them hambone and mouse bellies, but they are hovering too distantly, far across the world, peering at me through a loose association of ssh keys.</P>


	<P>I maintain Syck, the <SPAN class="caps">YAML</SPAN> processor which comes with Ruby.  And while I handle the large body of commits to Syck (with a huge one coming up very soon), every few months I get a surprise when Nobu or Matz dips into my code and crosses a huge calligraphic T.</P>


	<P>I’ve been sorting through a largish <A href="http://www.ruby-lang.org/cgi-bin/cvsweb.cgi/ruby/ext/syck/rubyext.c.diff?r1=1.30.2.7;r2=1.30.2.8;f=h">diff</A> from a few months ago, working on merging it into Syck 0.54.  Here’s a few things I’ve picked up from watching Nobu that I thought I’d pass on:</P>


	<H2>On checking strings, hashes, and arrays.</H2>


	<P>This is documented in the PickAxe II.  So it’s not terribly new news, but I thought I would reiterate here, since it’s an important change in the 1.8 series.</P>


	<P>With <SPAN class="caps">YAML</SPAN>, I’m boiling every object down into a string, array or hash.  Typing tags are used in the <SPAN class="caps">YAML</SPAN> to indicate what that object is in Ruby’s native types.  (For example, the number <CODE>1</CODE> in <SPAN class="caps">YAML</SPAN> is loaded as an integer, but you can also get an integer by using <CODE>!int "1"</CODE>.)  In one part of the extension, I need to determine if an incoming <SPAN class="caps">VALUE</SPAN> is a string, array or hash.  My previous code looked something like this:</P>


<PRE> if ( rb_respond_to( obj, rb_intern("to_str") ) ) {
   /* string conversion to YAML */
 } else if ( rb_obj_is_kind_of( obj, rb_cArray ) ) {
   /* array conversion to YAML */
 } else if ( rb_obj_is_kind_of( obj, rb_cHash ) ) {
   /* hash conversion to YAML */
 } else {
   /* raise exception */
 }
</PRE>

	<P>Nobu replaced the code with the new 1.8 duck-friendly turnstyle:</P>


<PRE> VALUE tmp;
 if (!NIL_P(tmp = rb_check_string_type(obj))) {
   obj = tmp; /* string */
 } else if (!NIL_P(tmp = rb_check_array_type(obj))) {
   obj = tmp; /* array */
 } else if (!NIL_P(tmp = rb_check_convert_type(obj, T_HASH, "Hash", "to_hash"))) {
   obj = tmp; /* hash */
 } else {
   /* exception */
 }
</PRE>

	<P>Note <CODE>to_hash</CODE>.  In other places, where I was keeping <SPAN class="caps">VALU</SPAN>Es in my own structs, Nobu allowed looser type checking.  I imagine there’s a but of overhead in the above that can be avoided if the types have been checked already.</P>


<PRE> VALUE dest = (VALUE)emitter-&gt;bonus;
 if (TYPE(dest)  T_STRING) {
   rb_str_cat( dest, str, len );
 } else {
   rb_io_write( dest, rb_str_new( str, len ) );
 }
</PRE>

	<H2>Doing StringValue() upfront.</H2>


	<P>In the extension, I have some <CODE>write</CODE> methods for the <SPAN class="caps">YAML</SPAN> emitter.  Strings can get passed directly to the <SPAN class="caps">YAML</SPAN> stream.  At the beginning of the method, I load the emitter object and check the string.</P>


<PRE> Data_Get_Struct(self, SyckEmitter, emitter);
 StringValue(str);
</PRE>

	<P>Wherever I had code like this, Nobu swapped the lines.</P>


<PRE> StringValue(str);
 Data_Get_Struct(self, SyckEmitter, emitter);
</PRE>

	<P>It occured to me that <CODE>StringValue</CODE> could throw an exception and it is also the more likely of the two to throw an exception.  I’m guessing he put it first to get the simple check out of the way and to avoid the overhead of retrieving the SyckEmitter struct if the <CODE>str</CODE> ends up being something else.</P>


	<H2>Using StringValue()’s return.</H2>


	<P>Nobu also consolidated my conditionals which checked the pointer and the length for a string.  The previous code:</P>


<PRE> if (NIL_P(type) ||!RSTRING(type)-&gt;ptr || RSTRING(type)-&gt;len  0)
</PRE>

	<P>Became:</P>


<PRE> if (NIL_P(type) ||RSTRING(StringValue(type))-&gt;len == 0)
</PRE>

	<H2>No more overriding Klass#new.</H2>


	<P>Finally, and this is in the PickAxe II as well, Nobu moved all my singletons which were defining <CODE>new</CODE> for various classes.  He turned them into 1.8 allocators.</P>


	<P>Previously, I had methods like this:</P>


<PRE> /* YAML::Syck::Emitter.new declaration */
 VALUE 
 syck_emitter_new(argc, argv, class)
     int argc;
     VALUE *argv;
     VALUE class;
 { ...; }

 /* Later, in Init_Syck... */
 rb_define_singleton_method( cEmitter, "new", syck_emitter_new, -1 );
</PRE>

	<P>Nobu’s allocator involved very simple changes:</P>


<PRE> /* YAML::Syck::Emitter.allocate declaration */
 VALUE
 syck_emitter_s_alloc(class)
     VALUE class;
 { ...; }

 /* Later, in Init_Syck... */
 rb_define_alloc_func( cEmitter, syck_emitter_s_alloc );
</PRE>

	<P>Many of these changes illustrated the simplicity of the new <SPAN class="caps">API</SPAN> the Ruby-Core team has provided with 1.8.  Most changes involved a simple line swap and were more powerful, to boot.  And I’m also very glad for Nobu and Matz, their attention to my little module, their pruning and caretaking from time-to-time.</P></DIV> 
</DIV>
<DIV class="entryFooter"> 
    <NOBR>04 Apr 2005</NOBR> at <NOBR>10:34</NOBR>
    <NOSCRIPT></NOSCRIPT>
   | 
    6 comments
</DIV>
</DIV>
<DIV id="comments">


<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>Daniel Berger</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>04 Apr 2005</NOBR> at <NOBR>14:15</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P>All very well and good, but when are you going to compile with -Wall? :)</P></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>the AC</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>04 Apr 2005</NOBR> at <NOBR>19:03</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P>or -O3</P></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>Daniel Berger</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>04 Apr 2005</NOBR> at <NOBR>19:27</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P>-O3 does bad things to Ruby.</P></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>e</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>04 Apr 2005</NOBR> at <NOBR>20:00</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P>Compilation should always succeed -Werror -Wall -pedantic -ansi. It’s unit testing for C :)</P></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>Anon</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>04 Apr 2005</NOBR> at <NOBR>22:54</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P>Isn’t this pre-Ansi C? I haven’t seen anything like this for 15+ years. Why this choice?</P></DIV></DIV>
</DIV>

<DIV class="entry">
    <DIV class="entryAttrib">
        <DIV class="entryAuthor"><H3>D</H3></DIV>
        <DIV class="entryTime">said on 
    <NOBR>09 Apr 2005</NOBR> at <NOBR>12:16</NOBR>
    <NOSCRIPT></NOSCRIPT>
  </DIV>
    </DIV>
    <DIV class="entryContentOuter"><DIV class="entryContent"><P>What if you want pre-1.8 compatability, do you not use the rb_check*_type functions?</P></DIV></DIV>
</DIV>


  <DIV class="entry">
    <P><SMALL>Comments are closed for this entry.</SMALL></P>
  



        </DIV> 

</DIV>



</DIV>





</DIV></BODY></HTML>